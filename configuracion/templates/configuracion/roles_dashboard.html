{% extends "base_star.html" %}
{% load static %}
{% block title %}Roles y permisos{% endblock %}

{% block content %}
<div class="row mb-3">
  <div class="col-6 d-flex align-items-center">
    <a href="{% url 'configuracion:dashboard' %}" class="btn btn-light btn-sm me-2">
      ← Volver
    </a>
    <div>
      <h4 class="mb-0">Roles y permisos</h4>
      <small class="text-muted">Administración de accesos y usuarios del sistema.</small>
    </div>
  </div>
</div>

<div class="row">
  <!-- ROLES -->
  <div class="col-lg-6 mb-4">
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="card-title mb-0">Roles</h5>
          <a href="{% url 'configuracion:grupo_nuevo' %}" class="btn btn-sm btn-primary">
            + Nuevo rol
          </a>
        </div>

        {% if grupos %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Módulos</th>
                  <th class="text-end">Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for g in grupos %}
                  <tr>
                    <td>{{ g.name }}</td>
                    <td>
                      {% with perms=g.permissions.all %}
                        {% if perms %}
                          {% for p in perms %}
                            <span class="badge bg-primary">
                              {{ p.name|cut:"Acceso módulo: " }}
                            </span>
                          {% endfor %}
                        {% else %}
                          <span class="text-muted small">Sin módulos asignados</span>
                        {% endif %}
                      {% endwith %}
                    </td>
                    <td class="text-end">
                      <a href="{% url 'configuracion:grupo_editar' g.id %}"
                         class="btn btn-sm btn-outline-secondary me-1">
                        Editar
                      </a>
                      <form method="post"
                            action="{% url 'configuracion:grupo_eliminar' g.id %}"
                            style="display:inline-block;"
                            onsubmit="return confirm('¿Eliminar este rol?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                          Eliminar
                        </button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted mb-0">Todavía no hay roles definidos.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- USUARIOS -->
  <div class="col-lg-6 mb-4">
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="card-title mb-0">Usuarios</h5>
          <a href="{% url 'configuracion:usuario_nuevo' %}" class="btn btn-sm btn-primary">
            + Nuevo usuario
          </a>
        </div>

        {% if usuarios %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Usuario</th>
                  <th>Nombre</th>
                  <th>Roles</th>
                  <th class="text-end">Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for u in usuarios %}
                  <tr>
                    <td>{{ u.username }}</td>
                    <td>{{ u.get_full_name|default:"—" }}</td>
                    <td>
                      {% for g in u.groups.all %}
                        <span class="badge bg-primary">{{ g.name }}</span>
                      {% empty %}
                        <span class="text-muted small">Sin rol</span>
                      {% endfor %}
                    </td>
                    <td class="text-end">
                      <a href="{% url 'configuracion:usuario_editar_roles' u.id %}"
                         class="btn btn-sm btn-outline-secondary me-1">
                        Editar
                      </a>
                      <form method="post"
                            action="{% url 'configuracion:usuario_eliminar' u.id %}"
                            style="display:inline-block;"
                            onsubmit="return confirm('¿Eliminar este usuario?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-danger"
                                {% if request.user.id == u.id %}disabled title="No puedes eliminar tu propio usuario"{% endif %}>
                          Eliminar
                        </button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted mb-0">No hay usuarios registrados.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
