{% extends "base_star.html" %}
{% block title %}Mensaje HL7{% endblock %}

{% block content %}
<div class="page-header">
  <h3 class="page-title">Detalle de Mensaje HL7</h3>
</div>

<div class="row">

  <!-- COLUMNA IZQUIERDA -->
  <div class="col-md-3 grid-margin stretch-card">
    <div class="card">
      <div class="card-body">

        <a href="{% url 'configuracion:hl7_historial' %}"
           class="btn btn-light btn-sm mb-3">
          ← Volver
        </a>

        <h4 class="mb-2">Información</h4>
        <p class="text-muted">
          Visualización del mensaje recibido desde el equipo.
        </p>

        <hr>

        <h5 class="mb-2">Gráficas del equipo</h5>
        <p class="text-muted mb-2" style="font-size: 12px;">
          Previsualización generada a partir de los datos HL7.
        </p>

        <div class="mb-3">
          <small class="text-muted d-block">RBC Histogram</small>
          <canvas id="rbc-hist" width="240" height="80"
                  style="width: 100%; border-radius: 4px; background:#fafafa;"></canvas>
        </div>

        <div class="mb-3">
          <small class="text-muted d-block">PLT Histogram</small>
          <canvas id="plt-hist" width="240" height="80"
                  style="width: 100%; border-radius: 4px; background:#fafafa;"></canvas>
        </div>

        <div class="mb-3">
          <small class="text-muted d-block">DIFF Scatter</small>
          <canvas id="diff-scatter" width="240" height="120"
                  style="width: 100%; border-radius: 4px; background:#fafafa;"></canvas>
        </div>

        <div class="mb-1">
          <small class="text-muted d-block">BASO Scatter</small>
          <canvas id="baso-scatter" width="240" height="120"
                  style="width: 100%; border-radius: 4px; background:#fafafa;"></canvas>
        </div>

        <small class="text-muted d-block mt-2" style="font-size:11px;">
        <!--aqui. viene texto de algun tipo de disclaime que se quiera mostrar debajo de la grafias-->
        </small>

      </div>
    </div>
  </div>

  <!-- COLUMNA DERECHA -->
  <div class="col-md-9 grid-margin stretch-card">
    <div class="card">
      <div class="card-body">

        <h4 class="mb-3">Mensaje Recibido</h4>

        <div class="mb-3">
          <strong>Fecha:</strong> {{ msg.fecha_recepcion }}<br>
          <strong>IP Equipo:</strong> {{ msg.ip_equipo }}<br>
          <strong>Sample ID:</strong> {{ msg.sample_id }}<br>
          <strong>Códigos:</strong> {{ msg.exam_codes }}
        </div>

        <h5 class="mt-4">Contenido HL7</h5>
        <pre id="hl7-raw"
             style="background:#f5f5f5; padding:15px; border-radius:6px; font-size:12px; max-height:320px; overflow:auto;">
{{ msg.mensaje_raw }}
        </pre>

        <h5 class="mt-4">Segmentos</h5>

        <div class="mt-3">
          <strong>MSH:</strong>
          <pre style="background:#fafafa; padding:10px; font-size:12px;">{{ msg.msh }}</pre>

          <strong>PID:</strong>
          <pre style="background:#fafafa; padding:10px; font-size:12px;">{{ msg.pid }}</pre>

          <strong>OBR:</strong>
          <pre style="background:#fafafa; padding:10px; font-size:12px;">{{ msg.obr }}</pre>

          <strong>OBX:</strong>
          <pre style="background:#fafafa; padding:10px; font-size:12px;">{{ msg.obx }}</pre>
        </div>

      </div>
    </div>
  </div>

</div>

<script>
(function(){
  const pre = document.getElementById('hl7-raw');
  if (!pre) return;

  const text = pre.innerText || pre.textContent || '';
  const lines = text.split(/[\r\n]+/);

  let rbcHist = null, pltHist = null, diffScatter = null, basoScatter = null;

  // Extrae el valor del OBX de forma flexible
  function extractValueFromObx(line) {
    const parts = line.split('|');
    if (parts.length >= 6) {
      return (parts[5] || '').trim();
    }
    const idx = line.indexOf('||');
    if (idx !== -1) {
      return line.substring(idx + 2).trim();
    }
    return '';
  }

  // Buscamos solo por texto dentro de toda la línea
  lines.forEach(function(lineRaw){
    const line = (lineRaw || '').trim();
    if (!line.startsWith('OBX|')) return;

    if (line.indexOf('RBC Histogram.Binary') !== -1) {
      rbcHist = extractValueFromObx(line);
    } else if (line.indexOf('PLT Histogram.Binary') !== -1) {
      pltHist = extractValueFromObx(line);
    } else if (line.indexOf('DIFFScatter.Binary') !== -1 ||
               line.indexOf('DIFF Scatter.Binary') !== -1) {
      diffScatter = extractValueFromObx(line);
    } else if (line.indexOf('BASOScatter.Binary') !== -1 ||
               line.indexOf('BASO Scatter.Binary') !== -1) {
      basoScatter = extractValueFromObx(line);
    }
  });

  function parseHist(str){
    if (!str) return null;
    const parts = str.split(';');
    if (parts.length < 2) return null;

    const colorInt = parseInt(parts[0], 10) || 0;
    const colorHex = '#' + colorInt.toString(16).padStart(6, '0');

    const values = parts[1].split(',').map(function(x){
      const v = parseInt(x, 10);
      return isNaN(v) ? 0 : v;
    }).filter(function(v){ return typeof v === 'number'; });

    if (!values.length) return null;
    return { color: colorHex, values: values };
  }

  // ⬇️ SOLO CAMBIA ESTA PARTE: ahora soporta múltiples colores/grupos
  function parseScatter(str){
    if (!str) return null;
    const s = String(str).trim();
    if (!s) return null;

    // Ejemplo soportado:
    // "16711680,(10,20)(30,40);255,(5,5)(6,7)"
    // o con '|' en vez de ';'
    const chunks = s.split(/[;|]/);
    const groups = [];

    chunks.forEach(function(chunk){
      const c = chunk.trim();
      if (!c) return;

      // primeros dígitos = color
      const colorMatch = c.match(/^(\d+)[,]?/);
      if (!colorMatch) return;

      const colorInt = parseInt(colorMatch[1], 10) || 0;
      const colorHex = '#' + colorInt.toString(16).padStart(6, '0');

      // resto = lista de puntos (x,y)
      const rest = c.replace(/^(\d+)[,]?/, '');
      const regex = /\((\d+),(\d+)\)/g;
      const pts = [];
      let m;
      while ((m = regex.exec(rest)) !== null){
        const x = parseInt(m[1], 10);
        const y = parseInt(m[2], 10);
        if (!isNaN(x) && !isNaN(y)) {
          pts.push({ x: x, y: y });
        }
      }

      if (pts.length){
        groups.push({ color: colorHex, points: pts });
      }
    });

    if (!groups.length) return null;
    return { groups: groups };
  }

  function drawHist(canvasId, data){
    const canvas = document.getElementById(canvasId);
    if (!canvas || !data) return;
    const ctx = canvas.getContext('2d');
    const w = canvas.width;
    const h = canvas.height;
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0,0,w,h);

    const maxVal = Math.max.apply(null, data.values.concat([1]));
    const step = Math.max(w / data.values.length, 1);

    ctx.strokeStyle = data.color;
    ctx.lineWidth = 1;
    ctx.beginPath();
    data.values.forEach(function(v, i){
      const x = i * step;
      const y = h - 4 - (v / maxVal) * (h - 8);
      if (i === 0){
        ctx.moveTo(x, y);
      } else {
        ctx.lineTo(x, y);
      }
    });
    ctx.stroke();
  }

  // ⬇️ AHORA DIBUJA TODOS LOS GRUPOS CON SU PROPIO COLOR
  function drawScatter(canvasId, data){
    const canvas = document.getElementById(canvasId);
    if (!canvas || !data || !data.groups) return;
    const ctx = canvas.getContext('2d');
    const w = canvas.width;
    const h = canvas.height;
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0,0,w,h);

    // Un solo sistema de coordenadas para todos los grupos
    const allPoints = [];
    data.groups.forEach(function(g){
      allPoints.push.apply(allPoints, g.points);
    });
    if (!allPoints.length) return;

    const xs = allPoints.map(function(p){ return p.x; });
    const ys = allPoints.map(function(p){ return p.y; });
    const minX = Math.min.apply(null, xs);
    const maxX = Math.max.apply(null, xs);
    const minY = Math.min.apply(null, ys);
    const maxY = Math.max.apply(null, ys);
    const pad  = 4;

    data.groups.forEach(function(group){
      ctx.fillStyle = group.color;
      group.points.forEach(function(p){
        const x = pad + ((p.x - minX) / ((maxX - minX) || 1)) * (w - pad * 2);
        const y = h - (pad + ((p.y - minY) / ((maxY - minY) || 1)) * (h - pad * 2));
        ctx.beginPath();
        ctx.arc(x, y, 1.3, 0, Math.PI * 2);
        ctx.fill();
      });
    });
  }

  const rbcData  = parseHist(rbcHist);
  const pltData  = parseHist(pltHist);
  const diffData = parseScatter(diffScatter);
  const basoData = parseScatter(basoScatter);

  drawHist('rbc-hist', rbcData);
  drawHist('plt-hist', pltData);
  drawScatter('diff-scatter', diffData);
  drawScatter('baso-scatter', basoData);
})();
</script>
{% endblock %}
