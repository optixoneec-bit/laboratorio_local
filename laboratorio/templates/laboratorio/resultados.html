{% extends "base.html" %}
{% block title %}Cargar Resultados ‚Äî {{ orden.numero_orden }}{% endblock %}

{% block extra_head %}
<style>
:root{
  --slx-blue:#2d7bd8;
  --slx-cyan:#29a7a4;
  --slx-border:#e3e6ea;
  --slx-bg:#fff;
  --slx-gray:#8e98a7;
  --slx-red:#e85a5e;
  --slx-green:#2fa36a;
}
.slx-card{
  background:var(--slx-bg);
  border:1px solid var(--slx-border);
  border-radius:12px;
  padding:18px 20px;
  box-shadow:0 2px 6px rgba(0,0,0,.04);
}
.slx-title{
  background:var(--slx-blue);
  color:#fff;
  font-weight:700;
  padding:10px 14px;
  border-radius:8px;
  margin-bottom:14px;
  text-transform:uppercase;
  display:flex;
  align-items:center;
  gap:8px;
}
.slx-title span.icon{font-size:1.2rem;}
.slx-btn{
  background:var(--slx-blue);
  color:#fff;
  border:0;
  border-radius:8px;
  padding:8px 14px;
  font-weight:600;
  cursor:pointer;
  transition:background .2s ease;
}
.slx-btn:hover{ background:#1f66c2; }
.slx-btn.green{ background:var(--slx-green); }
.slx-btn.green:hover{ background:#248e5a; }
.slx-btn.gray{ background:#ddd; color:#333; }
.slx-area{
  margin-top:22px;
  border:1px solid var(--slx-border);
  border-radius:10px;
  overflow:hidden;
}
.slx-area-header{
  background:var(--slx-cyan);
  color:#fff;
  font-weight:700;
  padding:8px 12px;
  text-transform:uppercase;
  font-size:.9rem;
}
.slx-table{
  width:100%;
  border-collapse:collapse;
}
.slx-table th{
  background:#f9fafb;
  text-align:left;
  padding:8px;
  border-bottom:1px solid var(--slx-border);
  font-size:.85rem;
  color:#444;
}
.slx-table td{
  padding:8px;
  border-bottom:1px solid var(--slx-border);
  font-size:.9rem;
  vertical-align:middle;
}
.slx-input{
  width:100%;
  border:1px solid var(--slx-border);
  border-radius:6px;
  padding:6px 8px;
  font-size:.85rem;
}
.icon-flag{font-weight:bold;}
.icon-flag.up{color:var(--slx-red);}
.icon-flag.down{color:#d97706;}
.icon-flag.ok{color:var(--slx-green);}
.text-muted{color:var(--slx-gray);}
.alert-success{
  background:#d1fae5;
  border:1px solid #34d399;
  color:#065f46;
  padding:6px 10px;
  border-radius:6px;
  margin-top:10px;
  font-size:.85rem;
}
</style>
{% endblock %}

{% block content %}
<div class="slx-card">
  <div class="slx-title"><span class="icon">üß™</span> CARGA DE RESULTADOS ‚Äî {{ orden.numero_orden }}</div>

  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
    <a href="{% url 'resultados_lista' %}" class="slx-btn gray">‚Üê Volver</a>
    <button class="slx-btn green" id="btnGuardar">üíæ Guardar Cambios</button>
  </div>

  <p style="margin:0 0 14px;color:#555;font-size:.9rem;">
    Paciente: <strong>{{ orden.paciente.nombre_completo }}</strong> &nbsp; | &nbsp;
    Documento: <strong>{{ orden.paciente.documento_identidad }}</strong> &nbsp; | &nbsp;
    Fecha: <strong>{{ orden.fecha|date:"d/m/Y H:i" }}</strong>
  </p>

  {% regroup examenes by examen.area as examenes_por_area %}
  {% for area in examenes_por_area %}
    <div class="slx-area">
      <div class="slx-area-header">{{ area.grouper }}</div>
      <table class="slx-table">
        <thead>
          <tr>
            <th style="width:25%">Par√°metro</th>
            <th style="width:12%">Resultado</th>
            <th style="width:10%">Unidad</th>
            <th style="width:18%">Referencia</th>
            <th style="width:20%">M√©todo</th>
            <th style="width:15%">Observaciones</th>
            <th style="width:5%">‚úî</th>
          </tr>
        </thead>
        <tbody>
        {% for ex in area.list %}
          {% if ex.resultados.exists %}
            {% for r in ex.resultados.all %}
              <tr data-id="{{ r.id }}">
                <td>{{ r.parametro }}</td>
                <td><input type="text" class="slx-input campo-valor" value="{{ r.valor }}"></td>
                <td><input type="text" class="slx-input campo-unidad" value="{{ r.unidad }}"></td>
                <td><input type="text" class="slx-input campo-ref" value="{{ r.referencia }}"></td>
                <td><input type="text" class="slx-input campo-metodo" value="{{ r.metodo }}"></td>
                <td><input type="text" class="slx-input campo-obs" value="{{ r.observacion }}"></td>
                <td style="text-align:center;"><button class="slx-btn green btn-save" data-id="{{ r.id }}">‚úî</button></td>
              </tr>
            {% endfor %}
          {% else %}
              <tr data-ordenex="{{ ex.id }}">
                <td colspan="7" class="text-muted">Sin par√°metros cargados para {{ ex.examen.nombre }}</td>
              </tr>
          {% endif %}
        {% endfor %}
        </tbody>
      </table>
    </div>
  {% empty %}
    <p class="text-muted">No hay ex√°menes en esta orden.</p>
  {% endfor %}

  <div id="alerta" class="alert-success" style="display:none;">‚úÖ Cambios guardados correctamente.</div>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{
  const alerta=document.getElementById('alerta');
  document.querySelectorAll('.btn-save').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const row=btn.closest('tr');
      const id=btn.dataset.id;
      const valor=row.querySelector('.campo-valor').value;
      const unidad=row.querySelector('.campo-unidad').value;
      const ref=row.querySelector('.campo-ref').value;
      const metodo=row.querySelector('.campo-metodo').value;
      const obs=row.querySelector('.campo-obs').value;
      const csrf=document.querySelector('[name=csrfmiddlewaretoken]').value;

      fetch("{% url 'guardar_resultados_ajax' %}",{
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'X-CSRFToken':csrf
        },
        body:JSON.stringify({
          id:id,
          valor:valor,
          unidad:unidad,
          referencia:ref,
          metodo:metodo,
          observacion:obs
        })
      })
      .then(r=>r.json())
      .then(data=>{
        alerta.style.display='block';
        alerta.textContent='‚úÖ '+data.message;
        setTimeout(()=>{alerta.style.display='none';},2500);
      })
      .catch(()=>{
        alerta.style.display='block';
        alerta.textContent='‚ùå Error al guardar resultado.';
        alerta.style.background='#fee2e2';
        setTimeout(()=>{alerta.style.display='none';},2500);
      });
    });
  });
});
</script>
{% endblock %}
