{% extends "base_star.html" %}
{% load static %}
{% block title %}Carga de Resultados â€” {{ orden.numero_orden }}{% endblock %}

{% block extra_head %}
<style>
  /* =========================================
     1. ESTILOS GENERALES (Match con tu diseÃ±o)
     ========================================== */
  body { background: #f6f7fb !important; }

  .slx-card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,.05);
      padding: 24px;
      border: none;
      margin-top: 20px;
  }

  /* TÃ­tulos y textos */
  h4 { font-weight: 500; color: #333; margin: 0; }
  .text-label { font-size: 12px; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
  
  /* Botones estilo "Clean" */
  .btn-sm {
      padding: 5px 14px;
      font-size: 14px;
      border-radius: 6px;
      font-weight: 500;
      display: inline-flex; align-items: center; gap: 6px;
  }
  .btn-primary { background-color: #4f6bdc; border-color: #4f6bdc; }
  .btn-primary:hover { background-color: #3d54c7; border-color: #3d54c7; }

  /* =========================================
     2. TARJETA DEL PACIENTE (Header Visual)
     ========================================== */
  .patient-header {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 16px 20px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
  }
  .patient-avatar {
      width: 42px; height: 42px;
      background: rgba(79, 107, 220, 0.1);
      color: #4f6bdc;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; margin-right: 15px;
  }
  .patient-name { font-size: 16px; font-weight: 600; color: #212529; margin-bottom: 2px; }
  .patient-meta { font-size: 13px; color: #6c757d; display: flex; align-items: center; gap: 10px; }

  /* =========================================
     3. TABLA PRINCIPAL (Estilo "Lista")
     ========================================== */
  .area-badge {
      display: inline-block;
      background: #eef2ff; color: #4f6bdc;
      padding: 6px 12px; border-radius: 6px;
      font-weight: 600; font-size: 13px;
      margin-top: 24px; margin-bottom: 12px;
  }

  .table-responsive {
      border: 1px solid #e9ecef;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 10px;
  }
  .table { margin-bottom: 0; }
  
  .table th {
      background: #f8f9fa;
      color: #495057;
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
      border-bottom: 1px solid #e9ecef;
      padding: 12px 16px;
  }
  .table td {
      vertical-align: middle !important;
      padding: 8px 16px;
      border-bottom: 1px solid #f1f3f5;
      color: #333;
      font-size: 14px;
      height: 45px; /* Altura mÃ­nima para que se vea ordenado */
  }
  .table tbody tr { background: #fff; }
  .table tbody tr:hover { background: #f1f5f9 !important; }

  /* --- INPUTS FANTASMA (Solo en la tabla principal) --- */
  /* Esto hace que parezca texto normal hasta que pasas el mouse */
  table .slx-input {
      width: 100%;
      background: transparent;
      border: 1px solid transparent; 
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 14px;
      color: #212529;
      transition: all 0.2s;
  }
  table .slx-input:hover, table .slx-input:focus {
      background: #fff;
      border-color: #ced4da;
      outline: none;
      box-shadow: 0 0 0 2px rgba(79, 107, 220, 0.1);
  }
  table .slx-input.campo-valor { font-weight: 600; color: #000; }

  /* =========================================
     4. MODALES (Esencial para que no se rompa JS)
     ========================================== */
  .modal {
      position: fixed !important;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9999 !important;
      display: none; /* JS usa display: flex al aÃ±adir .show */
      align-items: center; justify-content: center;
  }
  .modal.show { display: flex !important; }

  .modal-card {
      background: #fff;
      width: 95%; max-width: 750px;
      border-radius: 10px;
      box-shadow: 0 15px 30px rgba(0,0,0,0.2);
      display: flex; flex-direction: column;
      max-height: 90vh;
  }
  
  .modal-head {
      padding: 16px 24px;
      border-bottom: 1px solid #eee;
      background: #fff;
      border-radius: 10px 10px 0 0;
      display: flex; justify-content: space-between; align-items: center;
  }
  .modal-title { font-size: 18px; font-weight: 600; color: #333; }

  .modal-body { padding: 24px; overflow-y: auto; }

  .modal-foot {
      padding: 16px 24px;
      border-top: 1px solid #eee;
      background: #f8f9fa;
      border-radius: 0 0 10px 10px;
      display: flex; justify-content: flex-end; gap: 10px;
  }

  /* --- INPUTS DEL MODAL (Estilo Visible) --- */
  /* IMPORTANTE: Dentro del modal, los inputs deben tener borde siempre */
  .modal .slx-input, .modal textarea {
      display: block; width: 100%;
      padding: 8px 10px;
      font-size: 14px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      background-color: #fff;
  }
  .modal .slx-input:focus {
      border-color: #4f6bdc; outline: none;
      box-shadow: 0 0 0 3px rgba(79, 107, 220, 0.15);
  }

  /* --- GRID PARA JS (CRÃTICO) --- */
  /* El JS busca esta clase para inyectar el HTML de parÃ¡metros */
  .param-grid {
      display: grid;
      grid-template-columns: 1.4fr 1fr 1fr 1fr 1fr; /* Columnas ajustadas */
      gap: 12px;
      margin-bottom: 10px;
      align-items: center;
      font-size: 14px;
  }
  /* Encabezado del grid dentro del modal */
  .param-grid.fw-semibold {
      background: #f1f3f5;
      padding: 8px 0;
      border-radius: 4px;
      text-align: center;
      font-weight: 600;
      color: #495057;
      font-size: 12px;
      margin-bottom: 15px;
      border: 1px solid #e9ecef;
  }
  /* AlineaciÃ³n texto izquierda para la primera columna (ParÃ¡metro) */
  .param-grid > div:nth-child(5n+1) { padding-left: 10px; text-align: left; }

  /* =========================================
     5. OTROS (Alertas y Utilidades)
     ========================================== */
  .alert-success {
      position: fixed; bottom: 25px; right: 25px; z-index: 10000;
      background: #10b981; color: #fff; border: none;
      padding: 12px 20px; border-radius: 8px;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
      display: none; font-weight: 500;
  }
  .hidden { display: none; }
  .cursor-pointer { cursor: pointer; }
</style>
{% endblock %}

{% block content %}

<div class="slx-card">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-1">Carga de Resultados</h4>
        <div class="text-muted small">Orden #{{ orden.numero_orden }}</div>
    </div>

    <div class="d-flex gap-2">
      <a href="{% url 'resultados_lista' %}" class="btn btn-sm btn-outline-secondary">
        <i class="mdi mdi-arrow-left"></i> Volver
      </a>
      <button id="btnGuardarTodo" class="btn btn-sm btn-primary">
        <i class="mdi mdi-content-save-outline"></i> Guardar cambios
      </button>
    </div>
  </div>

  <div class="patient-header">
      <div class="d-flex align-items-center">
          <div class="patient-avatar">
             <i class="mdi mdi-account"></i>
          </div>
          <div>
              <div class="patient-name">{{ orden.paciente.nombre_completo }}</div>
              <div class="patient-meta">
                  <span><i class="mdi mdi-card-account-details-outline me-1"></i> {{ orden.paciente.documento_identidad }}</span>
                  <span class="mx-2">|</span>
                  <span><i class="mdi mdi-calendar-clock me-1"></i> {{ orden.fecha|date:"d/m/Y H:i" }}</span>
              </div>
          </div>
      </div>
      
      <span class="badge bg-white text-dark border px-3 py-2">{{ orden.estado }}</span>
  </div>

  <form class="hidden">{% csrf_token %}</form>

  {% regroup examenes by examen.area as examenes_por_area %}
  {% for area in examenes_por_area %}
    
    <div class="area-badge">{{ area.grouper }}</div>

    <div class="table-responsive">
      <table class="slx-table table table-hover">
        <thead>
          <tr>
            <th style="width: 25%;">ParÃ¡metro</th>
            <th style="width: 15%;">Resultado</th>
            <th style="width: 10%;">Unidad</th>
            <th style="width: 15%;">Referencia</th>
            <th style="width: 15%;">MÃ©todo</th>
            <th style="width: 15%;">Obs.</th>
            <th style="width: 5%; text-align: center;">Ok</th>
          </tr>
        </thead>

        <tbody>
        {% for ex in area.list %}
          {% if ex.resultados.exists %}
            {% for r in ex.resultados.all %}
            
            <tr class="param-row" data-id="{{ r.id }}" data-ordenex="{{ ex.id }}" data-param="{{ r.parametro|escapejs }}">
              
              <td class="fw-semibold text-secondary">{{ r.parametro }}</td>
              
              <td><input class="slx-input campo-valor" value="{{ r.valor }}" placeholder="-"></td>
              <td><input class="slx-input campo-unidad" value="{{ r.unidad }}"></td>
              <td><input class="slx-input campo-ref" value="{{ r.referencia }}"></td>
              <td><input class="slx-input campo-metodo" value="{{ r.metodo }}"></td>
              <td><input class="slx-input campo-obs" value="{{ r.observacion }}"></td>
              
              <td class="text-center">
                 <span class="campo-verificado badge {% if r.verificado %}bg-success bg-opacity-10 text-success{% else %}bg-light text-muted{% endif %}">
                    {{ r.verificado|yesno:"Si,No" }}
                 </span>
              </td>

            </tr>
            {% endfor %}

          {% else %}
            <tr class="fila-vacia" data-ordenex="{{ ex.id }}" style="cursor: pointer;">
              <td colspan="7" class="text-center py-4 text-muted">
                
                <div>
                    <i class="mdi mdi-playlist-plus fs-4 d-block mb-1"></i>
                    Sin parÃ¡metros cargados para <strong class="text-dark">{{ ex.examen.nombre }}</strong>
                    <span class="badge bg-light text-dark border ms-1">{{ ex.examen.codigo }}</span>
                    <div class="small mt-1 text-primary">Clic para cargar plantilla</div>
                </div>

                <script type="application/json" class="payload-parametros">
                [
                  {% for ep in ex.examen.parametros.all %}
                  {
                    "nombre":"{{ ep.nombre|escapejs }}",
                    "unidad":"{{ ep.unidad|default_if_none:''|escapejs }}",
                    "referencia":"{{ ep.referencia|default_if_none:''|escapejs }}",
                    "metodo":"{{ ep.metodo|default_if_none:''|escapejs }}",
                    "observacion":"{{ ep.observacion|default_if_none:''|escapejs }}"
                  }{% if not forloop.last %},{% endif %}
                  {% endfor %}
                ]
                </script>

              </td>
            </tr>
          {% endif %}
        {% endfor %}
        </tbody>
      </table>
    </div>
  {% endfor %}

  <div id="alerta" class="alert-success">
      <i class="mdi mdi-check-circle-outline me-1"></i> Cambios guardados correctamente.
  </div>

</div>


<div id="modalResultado" class="modal" aria-hidden="true">
  <div class="modal-card">

    <div class="modal-head">
      <div class="modal-title">ðŸ§ª Cargar ParÃ¡metros</div>
      <button id="m-cerrar" class="btn btn-sm btn-light text-muted" style="font-size:16px;">âœ•</button>
    </div>

    <div class="modal-body">
      
      <div class="d-flex gap-3 mb-4 p-3 bg-light rounded border">
          <div><strong class="text-muted d-block small">EXAMEN</strong> <span id="m-examen" class="fw-bold text-dark"></span></div>
          <div><strong class="text-muted d-block small">CÃ“DIGO</strong> <span id="m-codigo" class="fw-bold text-dark"></span></div>
      </div>

      <form id="form-burbuja">

        <div class="param-grid fw-semibold">
          <div>ParÃ¡metro</div>
          <div>Valor</div>
          <div>Unidad</div>
          <div>Ref.</div>
          <div>MÃ©todo</div>
        </div>

        <div id="m-parametros"></div>

        <div class="mt-4">
          <label class="text-label mb-2">ObservaciÃ³n General</label>
          <textarea class="slx-input" name="observacion_general" rows="2"></textarea>
        </div>

        <div class="mt-3">
          <label class="d-flex align-items-center gap-2 cursor-pointer">
              <input type="checkbox" id="m-verificado" style="width:16px; height:16px;">
              <span class="text-dark fw-medium">Marcar resultado como verificado</span>
          </label>
        </div>

      </form>

    </div>

    <div class="modal-foot">
      <button id="m-cancelar" class="btn btn-sm btn-outline-secondary">Cancelar</button>
      <button id="m-guardar" class="btn btn-sm btn-primary px-4">Guardar Datos</button>
    </div>

  </div>
</div>


<div id="modalResumen" class="modal" aria-hidden="true">
  <div class="modal-card">

    <div class="modal-head">
      <div class="modal-title">ðŸ§¾ Confirmar Resumen</div>
      <button id="mr-cerrar" class="btn btn-sm btn-light text-muted">âœ•</button>
    </div>

    <div class="modal-body">
      <div class="table-responsive border-0">
          <table class="table table-sm table-bordered">
            <thead class="table-light">
              <tr>
                <th>ParÃ¡metro</th><th>Valor</th><th>Unidad</th><th>Ref.</th><th>MÃ©todo</th><th>Obs</th><th>V</th>
              </tr>
            </thead>
            <tbody id="mr-body"></tbody>
          </table>
      </div>
      <div id="mr-msg" class="text-muted small mt-3 fst-italic text-center">
          Por favor verifica que todos los datos sean correctos antes de procesar.
      </div>
    </div>

    <div class="modal-foot">
      <button id="mr-volver" class="btn btn-sm btn-outline-secondary">Volver y Editar</button>
      <button id="mr-enviar" class="btn btn-sm btn-success px-4" disabled>Enviar a ValidaciÃ³n</button>
    </div>

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{
  const alerta=document.getElementById('alerta');
  const modal=document.getElementById('modalResultado');
  const modalResumen=document.getElementById('modalResumen');
  const mExamen=document.getElementById('m-examen');
  const mCodigo=document.getElementById('m-codigo');
  const mParametros=document.getElementById('m-parametros');
  const mNota=document.getElementById('m-nota'); // en esta versiÃ³n no existe, no pasa nada si queda null
  const mrBody=document.getElementById('mr-body');
  const mrMsg=document.getElementById('mr-msg');
  const btnEnviar=document.getElementById('mr-enviar');
  let currentOE=null;
  let currentMode='multiple'; // 'multiple' (fila vacÃ­a) o 'single' (clic en parÃ¡metro existente)
  let singleRowContext=null;  // {tr, id, param, unidad, ref, metodo, obs}

  const getCSRF = () => (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value || '';
  const showAlert = (msg,isErr=false)=>{
    alerta.style.display='block';
    alerta.textContent = (isErr?'âŒ ':'âœ… ')+msg;
    if(isErr){ alerta.style.background='#fee2e2'; }
    setTimeout(()=>{alerta.style.display='none'; alerta.style.background='';},2200);
  };
  const openModal = (el)=>{ el.classList.add('show'); el.setAttribute('aria-hidden','false'); };
  const closeModal = (el)=>{ el.classList.remove('show'); el.setAttribute('aria-hidden','true'); };

  // Clic en fila sin resultados -> burbuja mÃºltiple (catÃ¡logo)
  document.querySelectorAll('.fila-vacia').forEach(fila=>{
    fila.addEventListener('click',()=>{
      currentMode='multiple';
      singleRowContext=null;
      currentOE=fila.dataset.ordenex;
      const payloadTag=fila.querySelector('.payload-parametros');
      let params=[];
      try{ params=JSON.parse(payloadTag.textContent.trim()||'[]'); }catch(_){}
      const examenNombre = fila.querySelector('strong')?.textContent || '';
      const examenCodigo = fila.querySelector('.badge')?.textContent || '';

      mExamen.textContent = examenNombre;
      mCodigo.textContent = examenCodigo;

      mParametros.innerHTML='';
      if(!params || !params.length || !params[0].nombre){
        mParametros.innerHTML = '<p class="text-muted">Este examen no tiene parÃ¡metros definidos en el CatÃ¡logo TÃ©cnico.</p>';
        if(mNota){ mNota.textContent = 'Define primero los parÃ¡metros en CatÃ¡logo TÃ©cnico para este examen.'; }
      }else{
        if(mNota){ mNota.textContent = ''; }
        params.forEach((p)=>{
          const unidad = p.unidad || 'â€”';
          const referencia = p.referencia || 'â€”';
          const metodo = p.metodo || 'â€”';
          const row=document.createElement('div');
          row.className='param-grid';
          row.innerHTML=`
            <div class="param-nombre">
              ${p.nombre}
              <input type="hidden" name="parametro[]" value="${p.nombre}">
              <input type="hidden" name="unidad[]" value="${p.unidad||''}">
              <input type="hidden" name="referencia[]" value="${p.referencia||''}">
              <input type="hidden" name="metodo[]" value="${p.metodo||''}">
            </div>
            <div><input type="text" class="slx-input" name="valor[]" placeholder="Valor"></div>
            <div><span class="badge bg-light text-dark border">${unidad}</span></div>
            <div><span class="badge bg-light text-dark border">${referencia}</span></div>
            <div><span class="badge bg-light text-dark border">${metodo}</span></div>
          `;
          mParametros.appendChild(row);
        });
      }
      openModal(modal);
    });
  });

  // Clic en parÃ¡metro existente -> burbuja de un solo parÃ¡metro (ediciÃ³n)
  document.querySelectorAll('.param-row[data-id]').forEach(tr=>{
    tr.addEventListener('click',(e)=>{
      // Evita que el click en inputs internos reabra burbuja mientras escribe
      if(e.target && (e.target.tagName==='INPUT' || e.target.tagName==='BUTTON')) return;

      currentMode='single';
      currentOE=tr.dataset.ordenex;
      const param = tr.dataset.param || tr.children[0].textContent.trim();
      const valor = tr.querySelector('.campo-valor').value;
      const unidad = tr.querySelector('.campo-unidad').value;
      const ref = tr.querySelector('.campo-ref').value;
      const metodo = tr.querySelector('.campo-metodo').value;
      const obs = tr.querySelector('.campo-obs').value;

      singleRowContext = { tr, id: tr.dataset.id, param, unidad, referencia: ref, metodo: metodo, observacion: obs, valor: valor };

      mExamen.textContent = tr.closest('table').previousElementSibling?.textContent || '';
      mCodigo.textContent = '';
      mParametros.innerHTML = `
        <div class="param-grid">
          <div class="param-nombre">
            ${param}
            <input type="hidden" name="parametro[]" value="${param}">
            <input type="hidden" name="unidad[]" value="${unidad || ''}">
            <input type="hidden" name="referencia[]" value="${ref || ''}">
            <input type="hidden" name="metodo[]" value="${metodo || ''}">
          </div>
          <div><input type="text" class="slx-input" name="valor[]" placeholder="Valor" value="${valor || ''}"></div>
          <div><span class="badge bg-light text-dark border">${unidad || 'â€”'}</span></div>
          <div><span class="badge bg-light text-dark border">${ref || 'â€”'}</span></div>
          <div><span class="badge bg-light text-dark border">${metodo || 'â€”'}</span></div>
        </div>
      `;
      modal.querySelector('textarea[name="observacion_general"]').value = obs || '';
      modal.querySelector('#m-verificado').checked = false;
      openModal(modal);
    });
  });

  // Cerrar burbujas
  document.getElementById('m-cerrar').addEventListener('click',()=>closeModal(modal));
  document.getElementById('m-cancelar').addEventListener('click',()=>closeModal(modal));
  modal.addEventListener('click',(e)=>{ if(e.target===modal) closeModal(modal); });
  document.getElementById('mr-cerrar').addEventListener('click',()=>closeModal(modalResumen));
  document.getElementById('mr-volver').addEventListener('click', () => {
    closeModal(modalResumen);
  });

  // Guardar dentro de burbuja
  document.getElementById('m-guardar').addEventListener('click', async ()=>{
    const f=document.getElementById('form-burbuja');
    const parametros=[...f.querySelectorAll('input[name="parametro[]"]')].map(i=>i.value);
    const valores=[...f.querySelectorAll('input[name="valor[]"]')].map(i=>i.value.trim());
    const unidades=[...f.querySelectorAll('input[name="unidad[]"]')].map(i=>i.value);
    const referencias=[...f.querySelectorAll('input[name="referencia[]"]')].map(i=>i.value);
    const metodos=[...f.querySelectorAll('input[name="metodo[]"]')].map(i=>i.value);
    const obsGeneral = f.querySelector('textarea[name="observacion_general"]').value || '';
    const verificadoFlag = f.querySelector('#m-verificado').checked ? 'True' : 'False';
    const csrf=getCSRF();
    let ok=0, fail=0;
    let saves = [];

    if (currentMode === 'multiple') {
      for (let i = 0; i < parametros.length; i++) {
        const p = parametros[i], v = valores[i];
        if (!p || !v) continue;

        const body = new URLSearchParams();
        body.append('parametro', p);
        body.append('valor', v);
        body.append('unidad', unidades[i] || '');
        body.append('referencia', referencias[i] || '');
        body.append('metodo', metodos[i] || '');
        body.append('observacion', obsGeneral);
        body.append('verificado', verificadoFlag);

        saves.push(fetch("{% url 'registrar_resultado' 0 %}".replace('/0/', '/' + currentOE + '/'), {
          method: 'POST',
          headers: { 'X-CSRFToken': csrf, 'X-Requested-With': 'XMLHttpRequest' },
          body
        }).then(r => r.json()).then(data => {
          if (data.status === 'ok') ok++;
          else fail++;
        }).catch(() => { fail++; }));
      }
    } else {
      const ctx=singleRowContext;
      if(ctx && ctx.id){
        const payload = {
          id: ctx.id,
          valor: valores[0] || '',
          unidad: unidades[0] || '',
          referencia: referencias[0] || '',
          metodo: metodos[0] || '',
          observacion: obsGeneral,
        };

        saves.push(fetch("{% url 'guardar_resultados_ajax' %}",{
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'X-CSRFToken':csrf,
            'X-Requested-With':'XMLHttpRequest'
          },
          body:JSON.stringify(payload)
        }).then(r=>r.json()).then(data=>{
          if(data.status==='ok'){
            ok++;
            ctx.tr.querySelector('.campo-valor').value = payload.valor;
            ctx.tr.querySelector('.campo-unidad').value = payload.unidad;
            ctx.tr.querySelector('.campo-ref').value = payload.referencia;
            ctx.tr.querySelector('.campo-metodo').value = payload.metodo;
            ctx.tr.querySelector('.campo-obs').value = payload.observacion;
            const badge = ctx.tr.querySelector('.campo-verificado');
            if(badge){
              badge.textContent = f.querySelector('#m-verificado').checked ? 'SÃ­' : 'No';
            }
          } else {
            fail++;
          }
        }).catch(()=>{ fail++; }));
      }
    }

    await Promise.all(saves);

    closeModal(modal);

    if(ok > 0) {
        showAlert('Guardado exitoso');
        if (currentMode === 'multiple') {
            setTimeout(() => { window.location.href = "{% url 'resultados_lista' %}"; }, 600);
        }
    } else {
        showAlert('Nada guardado o error en el proceso', true);
    }
  });

  // Guardar cambios (muestra resumen con TODO)
  document.getElementById('btnGuardarTodo').addEventListener('click',()=>{
    mrBody.innerHTML='';
    let completos=true;

    document.querySelectorAll('.param-row[data-id]').forEach(tr=>{
      const param = tr.dataset.param || tr.children[0].textContent.trim();
      const valor = tr.querySelector('.campo-valor').value.trim();
      const unidad = tr.querySelector('.campo-unidad').value.trim();
      const ref = tr.querySelector('.campo-ref').value.trim();
      const metodo = tr.querySelector('.campo-metodo').value.trim();
      const obs = tr.querySelector('.campo-obs').value.trim();

      const verifEl = tr.querySelector('.campo-verificado');
      const verif = verifEl ? (verifEl.textContent.trim() || 'â€”') : 'â€”';

      const trR=document.createElement('tr');
      trR.innerHTML = `
        <td>${param}</td>
        <td>${valor}</td>
        <td>${unidad||'â€”'}</td>
        <td>${ref||'â€”'}</td>
        <td>${metodo||'â€”'}</td>
        <td>${obs||''}</td>
        <td>${verif}</td>
      `;
      mrBody.appendChild(trR);
      if(!valor) completos=false;
    });

    if(modal.classList.contains('show')){
      const f=document.getElementById('form-burbuja');
      const parametros=[...f.querySelectorAll('input[name="parametro[]"]')].map(i=>i.value);
      const valores=[...f.querySelectorAll('input[name="valor[]"]')].map(i=>i.value.trim());
      const unidades=[...f.querySelectorAll('input[name="unidad[]"]')].map(i=>i.value);
      const referencias=[...f.querySelectorAll('input[name="referencia[]"]')].map(i=>i.value);
      const metodos=[...f.querySelectorAll('input[name="metodo[]"]')].map(i=>i.value);
      const obsGeneral=f.querySelector('textarea[name="observacion_general"]').value || '';
      const verificado=f.querySelector('#m-verificado').checked ? 'SÃ­' : 'No';

      for(let i=0;i<parametros.length;i++){
        if(!parametros[i]) continue;
        const trR=document.createElement('tr');
        trR.innerHTML=`
          <td>${parametros[i]}</td>
          <td>${valores[i]||''}</td>
          <td>${unidades[i]||'â€”'}</td>
          <td>${referencias[i]||'â€”'}</td>
          <td>${metodos[i]||'â€”'}</td>
          <td>${obsGeneral}</td>
          <td>${verificado}</td>
        `;
        mrBody.appendChild(trR);
        if(!valores[i]) completos=false;
      }
    }

    btnEnviar.disabled = !completos;
    mrMsg.textContent = completos
      ? 'Todo completo. Puedes enviar a validaciÃ³n.'
      : 'Hay parÃ¡metros sin valor. Se guardarÃ¡n los completos y la orden quedarÃ¡ en espera.';
    openModal(modalResumen);
  });


  let enviarValidacion = false;

  btnEnviar.addEventListener('click', async () => {
    enviarValidacion = true;
    const csrf = getCSRF();
    let ok = 0, fail = 0;
    const saves = [];

    document.querySelectorAll('.param-row[data-id]').forEach(tr => {
      const id = tr.dataset.id;
      const payload = {
        id: id,
        valor: tr.querySelector('.campo-valor').value.trim(),
        unidad: tr.querySelector('.campo-unidad').value.trim(),
        referencia: tr.querySelector('.campo-ref').value.trim(),
        metodo: tr.querySelector('.campo-metodo').value.trim(),
        observacion: tr.querySelector('.campo-obs').value.trim(),
        accion: "enviar_validacion"
      };

      saves.push(fetch("{% url 'guardar_resultados_ajax' %}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf, 'X-Requested-With':'XMLHttpRequest' },
        body: JSON.stringify(payload)
      }).then(r => r.json()).then(d => {
        if (d.status === 'ok' || d.status === 'redirect') ok++;
        else fail++;
      }).catch(() => { fail++; }));
    });

    await Promise.all(saves);
    closeModal(modalResumen);

    if (ok > 0 && enviarValidacion) {
      showAlert('Resultados enviados a validaciÃ³n');
      setTimeout(() => {
        window.location.href = "{% url 'resultados_lista' %}";
      }, 1000);
    } else if (fail > 0) {
      showAlert('No se pudo guardar', true);
    }
  });

});
</script>

{% endblock %}
