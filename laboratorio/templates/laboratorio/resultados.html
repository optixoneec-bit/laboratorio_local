{% extends "base.html" %}
{% block title %}Cargar Resultados ‚Äî {{ orden.numero_orden }}{% endblock %}

{% block extra_head %}
<style>
:root{
  --slx-blue:#2d7bd8;
  --slx-cyan:#29a7a4;
  --slx-border:#e3e6ea;
  --slx-bg:#fff;
  --slx-gray:#8e98a7;
  --slx-red:#e85a5e;
  --slx-green:#2fa36a;
}
.slx-card{background:var(--slx-bg);border:1px solid var(--slx-border);border-radius:12px;padding:18px 20px;box-shadow:0 2px 6px rgba(0,0,0,.04);}
.slx-title{background:var(--slx-blue);color:#fff;font-weight:700;padding:10px 14px;border-radius:8px;margin-bottom:14px;text-transform:uppercase;display:flex;align-items:center;gap:8px;}
.slx-btn{background:var(--slx-blue);color:#fff;border:0;border-radius:8px;padding:8px 14px;font-weight:600;cursor:pointer;transition:background .2s ease;}
.slx-btn:hover{background:#1f66c2;}
.slx-btn.green{background:var(--slx-green);}
.slx-btn.green:hover{background:#248e5a;}
.slx-btn.gray{background:#ddd;color:#333;}
.slx-area{margin-top:22px;border:1px solid var(--slx-border);border-radius:10px;overflow:hidden;}
.slx-area-header{background:var(--slx-cyan);color:#fff;font-weight:700;padding:8px 12px;text-transform:uppercase;font-size:.9rem;}
.slx-table{width:100%;border-collapse:collapse;}
.slx-table th{background:#f9fafb;text-align:left;padding:8px;border-bottom:1px solid var(--slx-border);font-size:.85rem;color:#444;}
.slx-table td{padding:8px;border-bottom:1px solid var (--slx-border);font-size:.9rem;vertical-align:middle;}
.slx-input{width:100%;border:1px solid var(--slx-border);border-radius:6px;padding:6px 8px;font-size:.85rem;}
.text-muted{color:var(--slx-gray);}
.alert-success{background:#d1fae5;border:1px solid #34d399;color:#065f46;padding:6px 10px;border-radius:6px;margin-top:10px;font-size:.85rem;}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:5000;}
.modal.show{display:flex;}
.modal-card{background:#fff;border-radius:12px;min-width:360px;max-width:720px;width:96%;box-shadow:0 10px 30px rgba(0,0,0,.2);overflow:hidden;}
.modal-head{background:var(--slx-blue);color:#fff;font-weight:700;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;}
.modal-body{padding:14px;}
.modal-foot{display:flex;gap:8px;justify-content:flex-end;padding:12px;border-top:1px solid #eee;}
.param-grid{display:grid;grid-template-columns:1.3fr 0.9fr 0.8fr 1fr 1fr;gap:8px;align-items:center;margin-bottom:8px;}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.75rem;border:1px solid #e5e7eb;background:#f8fafc;color:#374151;}
.hidden{display:none;}
.table-mini{width:100%;border-collapse:collapse;}
.table-mini th,.table-mini td{border-bottom:1px solid #e5e7eb;padding:6px 8px;font-size:.86rem;text-align:left;}
.table-mini th{background:#f9fafb;}
.fila-vacia{cursor:pointer;}
.fila-vacia:hover{background:#f7fbff;}
.param-row{cursor:pointer;}
.param-row:hover{background:#f7fbff;}
.btn-save{display:none;} /* sin verificaci√≥n por examen */
</style>
{% endblock %}

{% block content %}
<div class="slx-card">
  <div class="slx-title"><span class="icon">üß™</span> CARGA DE RESULTADOS ‚Äî {{ orden.numero_orden }}</div>

  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
    <a href="{% url 'resultados_lista' %}" class="slx-btn gray">‚Üê Volver</a>
    <button class="slx-btn green" id="btnGuardarTodo">üíæ Guardar cambios</button>
  </div>

  <p style="margin:0 0 14px;color:#555;font-size:.9rem;">
    Paciente: <strong>{{ orden.paciente.nombre_completo }}</strong> &nbsp; | &nbsp;
    Documento: <strong>{{ orden.paciente.documento_identidad }}</strong> &nbsp; | &nbsp;
    Fecha: <strong>{{ orden.fecha|date:"d/m/Y H:i" }}</strong>
  </p>

  <form class="hidden">{% csrf_token %}</form>

  {% regroup examenes by examen.area as examenes_por_area %}
  {% for area in examenes_por_area %}
    <div class="slx-area">
      <div class="slx-area-header">{{ area.grouper }}</div>
      <table class="slx-table">
        <thead>
          <tr>
            <th style="width:25%">Par√°metro</th>
            <th style="width:12%">Resultado</th>
            <th style="width:10%">Unidad</th>
            <th style="width:18%">Referencia</th>
            <th style="width:20%">M√©todo</th>
            <th style="width:15%">Observaciones</th>
            <th style="width:5%">‚úî</th>
          </tr>
        </thead>
        <tbody>
        {% for ex in area.list %}
          {% if ex.resultados.exists %}
            {% for r in ex.resultados.all %}
              <tr class="param-row" data-id="{{ r.id }}" data-ordenex="{{ ex.id }}" data-param="{{ r.parametro|escapejs }}">
                <td>{{ r.parametro }}</td>
                <td><input type="text" class="slx-input campo-valor" value="{{ r.valor|default_if_none:'' }}"></td>
                <td><input type="text" class="slx-input campo-unidad" value="{{ r.unidad|default_if_none:'' }}"></td>
                <td><input type="text" class="slx-input campo-ref" value="{{ r.referencia|default_if_none:'' }}"></td>
                <td><input type="text" class="slx-input campo-metodo" value="{{ r.metodo|default_if_none:'' }}"></td>
                <td><input type="text" class="slx-input campo-obs" value="{{ r.observacion|default_if_none:'' }}"></td>
                <td style="text-align:center;"><span class="campo-verificado">{{ r.verificado|yesno:"S√≠,No" }}</span></td>
              </tr>
            {% endfor %}
          {% else %}
              <tr data-ordenex="{{ ex.id }}" class="fila-vacia">
                <td colspan="7" class="text-muted">
                  üîπ Sin par√°metros cargados para <strong>{{ ex.examen.nombre }}</strong>
                  <span class="badge">{{ ex.examen.codigo }}</span>
                  <script type="application/json" class="payload-parametros">
                    [
                      {% for ep in ex.examen.parametros.all %}
                        {
                          "nombre": "{{ ep.nombre|escapejs }}",
                          "unidad": "{{ ep.unidad|default_if_none:''|escapejs }}",
                          "referencia": "{{ ep.referencia|default_if_none:''|escapejs }}",
                          "metodo": "{{ ep.metodo|default_if_none:''|escapejs }}",
                          "observacion": "{{ ep.observacion|default_if_none:''|escapejs }}",
                          "acreditado": {{ ep.acreditado|yesno:"true,false" }}
                        }{% if not forloop.last %},{% endif %}
                      {% empty %}
                        { "nombre":"", "unidad":"", "referencia":"", "metodo":"", "observacion":"", "acreditado":false }
                      {% endfor %}
                    ]
                  </script>
                </td>
              </tr>
          {% endif %}
        {% endfor %}
        </tbody>
      </table>
    </div>
  {% empty %}
    <p class="text-muted">No hay ex√°menes en esta orden.</p>
  {% endfor %}

  <div id="alerta" class="alert-success" style="display:none;">‚úÖ Cambios guardados correctamente.</div>
</div>

<div id="modalResultado" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-head">
      <div>üß´ Par√°metros</div>
      <button type="button" id="m-cerrar" class="slx-btn gray">‚úñ</button>
    </div>
    <div class="modal-body">
      <div class="small" style="margin-bottom:10px;color:#555;">
        <div><strong>Examen:</strong> <span id="m-examen"></span></div>
        <div><strong>C√≥digo:</strong> <span id="m-codigo"></span></div>
      </div>
      <form id="form-burbuja">
        <div class="param-grid" style="font-weight:600;">
          <div>Par√°metro</div><div>Valor</div><div>Unidad</div><div>Referencia</div><div>M√©todo</div>
        </div>
        <div id="m-parametros"></div>

        <div style="margin-top:12px;">
          <label style="font-weight:600;">Observaciones:</label>
          <textarea name="observacion_general" class="slx-input" rows="2" placeholder="Observaciones generales..."></textarea>
        </div>
        <div style="margin-top:10px;display:flex;align-items:center;gap:6px;">
          <input type="checkbox" id="m-verificado" name="verificado">
          <label for="m-verificado" style="font-size:.9rem;">Resultado verificado</label>
        </div>
      </form>
      <div id="m-nota" class="text-muted" style="margin-top:6px;font-size:.82rem;"></div>
    </div>
    <div class="modal-foot">
      <button type="button" id="m-cancelar" class="slx-btn gray">Cancelar</button>
      <button type="button" id="m-guardar" class="slx-btn">Guardar</button>
    </div>
  </div>
</div>

<div id="modalResumen" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-head">
      <div>üßæ Resumen de resultados</div>
      <button type="button" id="mr-cerrar" class="slx-btn gray">‚úñ</button>
    </div>
    <div class="modal-body">
      <table class="table-mini">
        <thead>
          <tr>
            <th>Par√°metro</th>
            <th>Valor</th>
            <th>Unidad</th>
            <th>Referencia</th>
            <th>M√©todo</th>
            <th>Observaciones</th>
            <th>Verificado</th>
          </tr>
        </thead>
        <tbody id="mr-body"></tbody>
      </table>
      <div id="mr-msg" class="text-muted" style="margin-top:8px;font-size:.82rem;">Verifica los datos antes de enviar.</div>
    </div>
    <div class="modal-foot">
      <button type="button" id="mr-volver" class="slx-btn gray">Volver</button>
      <button type="button" id="mr-enviar" class="slx-btn green" disabled>Enviar a validaci√≥n</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{
  const alerta=document.getElementById('alerta');
  const modal=document.getElementById('modalResultado');
  const modalResumen=document.getElementById('modalResumen');
  const mExamen=document.getElementById('m-examen');
  const mCodigo=document.getElementById('m-codigo');
  const mParametros=document.getElementById('m-parametros');
  const mNota=document.getElementById('m-nota');
  const mrBody=document.getElementById('mr-body');
  const mrMsg=document.getElementById('mr-msg');
  const btnEnviar=document.getElementById('mr-enviar');
  let currentOE=null;
  let currentMode='multiple'; // 'multiple' (fila vac√≠a) o 'single' (clic en par√°metro existente)
  let singleRowContext=null;  // {tr, id, param, unidad, ref, metodo, obs}

  const getCSRF = () => (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value || '';
  const showAlert = (msg,isErr=false)=>{
    alerta.style.display='block';
    alerta.textContent = (isErr?'‚ùå ':'‚úÖ ')+msg;
    if(isErr){ alerta.style.background='#fee2e2'; }
    setTimeout(()=>{alerta.style.display='none'; alerta.style.background='';},2200);
  };
  const openModal = (el)=>{ el.classList.add('show'); el.setAttribute('aria-hidden','false'); };
  const closeModal = (el)=>{ el.classList.remove('show'); el.setAttribute('aria-hidden','true'); };

  // Clic en fila sin resultados -> burbuja m√∫ltiple (cat√°logo)
  document.querySelectorAll('.fila-vacia').forEach(fila=>{
    fila.addEventListener('click',()=>{
      currentMode='multiple';
      singleRowContext=null;
      currentOE=fila.dataset.ordenex;
      const payloadTag=fila.querySelector('.payload-parametros');
      let params=[];
      try{ params=JSON.parse(payloadTag.textContent.trim()||'[]'); }catch(_){}
      const examenNombre = fila.querySelector('strong')?.textContent || '';
      const examenCodigo = fila.querySelector('.badge')?.textContent || '';

      mExamen.textContent = examenNombre;
      mCodigo.textContent = examenCodigo;

      mParametros.innerHTML='';
      if(!params || !params.length || !params[0].nombre){
        mParametros.innerHTML = '<p class="text-muted">Este examen no tiene par√°metros definidos en el Cat√°logo T√©cnico.</p>';
        mNota.textContent = 'Define primero los par√°metros en Cat√°logo T√©cnico para este examen.';
      }else{
        mNota.textContent = '';
        params.forEach((p)=>{
          const unidad = p.unidad || '‚Äî';
          const referencia = p.referencia || '‚Äî';
          const metodo = p.metodo || '‚Äî'; // üëà Incluye el m√©todo
          const row=document.createElement('div');
          row.className='param-grid';
          row.innerHTML=`
            <div class="param-nombre">
              ${p.nombre}
              <input type="hidden" name="parametro[]" value="${p.nombre}">
              <input type="hidden" name="unidad[]" value="${p.unidad||''}">
              <input type="hidden" name="referencia[]" value="${p.referencia||''}">
              <input type="hidden" name="metodo[]" value="${p.metodo||''}"> <!-- üëà Incluye el m√©todo -->
            </div>
            <div><input type="text" class="slx-input" name="valor[]" placeholder="Valor"></div>
            <div><span class="badge">${unidad}</span></div>
            <div><span class="badge">${referencia}</span></div>
            <div><span class="badge">${metodo}</span></div> <!-- üëà Muestra el m√©todo -->
          `;
          mParametros.appendChild(row);
        });
      }
      openModal(modal);
    });
  });

  // Clic en par√°metro existente -> burbuja de un solo par√°metro (edici√≥n)
  document.querySelectorAll('.param-row[data-id]').forEach(tr=>{
    tr.addEventListener('click',(e)=>{
      // Evita que el click en inputs internos reabra burbuja mientras escribe
      if(e.target && (e.target.tagName==='INPUT' || e.target.tagName==='BUTTON')) return;

      currentMode='single';
      currentOE=tr.dataset.ordenex;
      const param = tr.dataset.param || tr.children[0].textContent.trim();
      const valor = tr.querySelector('.campo-valor').value;
      const unidad = tr.querySelector('.campo-unidad').value;
      const ref = tr.querySelector('.campo-ref').value;
      const metodo = tr.querySelector('.campo-metodo').value; // üëà Extrae el m√©todo
      const obs = tr.querySelector('.campo-obs').value;

      // Guarda el contexto de la fila seleccionada
      singleRowContext = { tr, id: tr.dataset.id, param, unidad, referencia: ref, metodo: metodo, observacion: obs, valor: valor };

      // Carga los valores en el modal
      mExamen.textContent = tr.closest('table').previousElementSibling?.textContent || '';
      mCodigo.textContent = '';
      mParametros.innerHTML = `
        <div class="param-grid">
          <div class="param-nombre">
            ${param}
            <input type="hidden" name="parametro[]" value="${param}">
            <input type="hidden" name="unidad[]" value="${unidad || ''}">
            <input type="hidden" name="referencia[]" value="${ref || ''}">
            <input type="hidden" name="metodo[]" value="${metodo || ''}"> <!-- üëà Incluye el m√©todo -->
          </div>
          <div><input type="text" class="slx-input" name="valor[]" placeholder="Valor" value="${valor || ''}"></div>
          <div><span class="badge">${unidad || '‚Äî'}</span></div>
          <div><span class="badge">${ref || '‚Äî'}</span></div>
          <div><span class="badge">${metodo || '‚Äî'}</span></div> <!-- üëà Muestra el m√©todo -->
        </div>
      `;
      modal.querySelector('textarea[name="observacion_general"]').value = obs || '';
      modal.querySelector('#m-verificado').checked = false;
      openModal(modal);
    });
  });

  // Cerrar burbujas
  document.getElementById('m-cerrar').addEventListener('click',()=>closeModal(modal));
  document.getElementById('m-cancelar').addEventListener('click',()=>closeModal(modal));
  modal.addEventListener('click',(e)=>{ if(e.target===modal) closeModal(modal); });
  document.getElementById('mr-cerrar').addEventListener('click',()=>closeModal(modalResumen));
  document.getElementById('mr-volver').addEventListener('click', () => {
    closeModal(modalResumen);
  });

  // Guardar dentro de burbuja (no avanza autom√°tico)
  document.getElementById('m-guardar').addEventListener('click', async ()=>{
    const f=document.getElementById('form-burbuja');
    const parametros=[...f.querySelectorAll('input[name="parametro[]"]')].map(i=>i.value);
    const valores=[...f.querySelectorAll('input[name="valor[]"]')].map(i=>i.value.trim());
    const unidades=[...f.querySelectorAll('input[name="unidad[]"]')].map(i=>i.value);
    const referencias=[...f.querySelectorAll('input[name="referencia[]"]')].map(i=>i.value);
    const metodos=[...f.querySelectorAll('input[name="metodo[]"]')].map(i=>i.value); // Obtener m√©todos
    const obsGeneral = f.querySelector('textarea[name="observacion_general"]').value || '';
    const csrf=getCSRF();
    let ok=0, fail=0;
    let saves = []; // Array para almacenar promesas de guardado

    if (currentMode === 'multiple') {
      // M√∫ltiple: crea nuevos registros (requiere recarga para verlos)
      for (let i = 0; i < parametros.length; i++) {
        const p = parametros[i], v = valores[i];
        if (!p || !v) continue;

        const body = new URLSearchParams();
        body.append('parametro', p);
        body.append('valor', v);
        body.append('unidad', unidades[i] || '');
        body.append('referencia', referencias[i] || '');
        body.append('metodo', metodos[i] || ''); // üëà Incluye el m√©todo individual
        body.append('observacion', obsGeneral); // üëà Incluye la observaci√≥n general
        body.append('verificado', f.querySelector('#m-verificado').checked ? 'True' : 'False'); // üëà Incluye el estado de verificado

        // Agregamos la promesa al array 'saves'
        saves.push(fetch("{% url 'registrar_resultado' 0 %}".replace('/0/', '/' + currentOE + '/'), {
          method: 'POST',
          headers: { 'X-CSRFToken': csrf, 'X-Requested-With': 'XMLHttpRequest' },
          body
        }).then(r => r.json()).then(data => {
          if (data.status === 'ok') ok++;
          else fail++;
        }).catch(() => { fail++; }));
      }
    } else {
      // Single: actualiza registro existente (actualizaci√≥n en DOM es local)
      const ctx=singleRowContext;
      if(ctx && ctx.id){
        const payload = {
          id: ctx.id,
          valor: valores[0] || '',
          unidad: unidades[0] || '',
          referencia: referencias[0] || '',
          metodo: metodos[0] || '', // üëà Incluye el m√©todo
          observacion: obsGeneral,  // üëà Incluye la observaci√≥n
        };

        // Agregamos la promesa al array 'saves'
        saves.push(fetch("{% url 'guardar_resultados_ajax' %}",{
          method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':csrf}, body:JSON.stringify(payload)
        }).then(r=>r.json()).then(data=>{
          if(data.status==='ok'){
            ok++;
            // REFLEJAR EN DOM INMEDIATAMENTE:
            ctx.tr.querySelector('.campo-valor').value = payload.valor;
            ctx.tr.querySelector('.campo-unidad').value = payload.unidad;
            ctx.tr.querySelector('.campo-ref').value = payload.referencia;
            ctx.tr.querySelector('.campo-metodo').value = payload.metodo;       // üëà Actualiza el m√©todo
            ctx.tr.querySelector('.campo-obs').value = payload.observacion;     // üëà Actualiza la observaci√≥n
            ctx.tr.querySelector('.campo-verificado').textContent = f.querySelector('#m-verificado').checked ? 'S√≠' : 'No'; // üëà Actualiza el estado de verificado
          } else {
            fail++;
          }
        }).catch(()=>{ fail++; }));
      }
    }

    // Esperar a que todas las peticiones terminen
    await Promise.all(saves);

    closeModal(modal);

    if(ok > 0) {
        showAlert('Guardado exitoso');
        if (currentMode === 'multiple') {
            // Si creamos nuevos elementos (multiple mode), recargamos para que Django los dibuje.
            setTimeout(() => { window.location.href = "{% url 'resultados_lista' %}"; }, 600);

        }
    } else {
        showAlert('Nada guardado o error en el proceso', true);
    }
  });

// Guardar cambios (muestra resumen con TODO)
document.getElementById('btnGuardarTodo').addEventListener('click',()=>{
  mrBody.innerHTML='';
  let completos=true;

  // Recoger existentes de la tabla (param-rows)
  document.querySelectorAll('.param-row[data-id]').forEach(tr=>{
    const param = tr.dataset.param || tr.children[0].textContent.trim();
    const valor = tr.querySelector('.campo-valor').value.trim();
    const unidad = tr.querySelector('.campo-unidad').value.trim();
    const ref = tr.querySelector('.campo-ref').value.trim();
    const metodo = tr.querySelector('.campo-metodo').value.trim();
    const obs = tr.querySelector('.campo-obs').value.trim();

    // ‚úÖ Captura real del estado verificado
    const verifEl = tr.querySelector('.campo-verificado');
    const verif = verifEl ? (verifEl.textContent.trim() || '‚Äî') : '‚Äî';

    const trR=document.createElement('tr');
    trR.innerHTML = `
      <td>${param}</td>
      <td>${valor}</td>
      <td>${unidad||'‚Äî'}</td>
      <td>${ref||'‚Äî'}</td>
      <td>${metodo||'‚Äî'}</td>
      <td>${obs||''}</td>
      <td>${verif}</td>
    `;
    mrBody.appendChild(trR);
    if(!valor) completos=false;
  });

  // Si hay par√°metros abiertos en la burbuja
  if(modal.classList.contains('show')){
    const f=document.getElementById('form-burbuja');
    const parametros=[...f.querySelectorAll('input[name="parametro[]"]')].map(i=>i.value);
    const valores=[...f.querySelectorAll('input[name="valor[]"]')].map(i=>i.value.trim());
    const unidades=[...f.querySelectorAll('input[name="unidad[]"]')].map(i=>i.value);
    const referencias=[...f.querySelectorAll('input[name="referencia[]"]')].map(i=>i.value);
    const metodos=[...f.querySelectorAll('input[name="metodo[]"]')].map(i=>i.value);
    const obsGeneral=f.querySelector('textarea[name="observacion_general"]').value || '';
    const verificado=f.querySelector('#m-verificado').checked ? 'S√≠' : 'No';

    for(let i=0;i<parametros.length;i++){
      if(!parametros[i]) continue;
      const trR=document.createElement('tr');
      trR.innerHTML=`
        <td>${parametros[i]}</td>
        <td>${valores[i]||''}</td>
        <td>${unidades[i]||'‚Äî'}</td>
        <td>${referencias[i]||'‚Äî'}</td>
        <td>${metodos[i]||'‚Äî'}</td>
        <td>${obsGeneral}</td>
        <td>${verificado}</td>
      `;
      mrBody.appendChild(trR);
      if(!valores[i]) completos=false;
    }
  }

  btnEnviar.disabled = !completos;
  mrMsg.textContent = completos
    ? 'Todo completo. Puedes enviar a validaci√≥n.'
    : 'Hay par√°metros sin valor. Se guardar√°n los completos y la orden quedar√° en espera.';
  openModal(modalResumen);
});


  let enviarValidacion = false;

  btnEnviar.addEventListener('click', async () => {
  enviarValidacion = true;
  const csrf = getCSRF();
  let ok = 0, fail = 0;
  const saves = [];

  document.querySelectorAll('.param-row[data-id]').forEach(tr => {
    const id = tr.dataset.id;
    const payload = {
      id: id,
      valor: tr.querySelector('.campo-valor').value.trim(),
      unidad: tr.querySelector('.campo-unidad').value.trim(),
      referencia: tr.querySelector('.campo-ref').value.trim(),
      metodo: tr.querySelector('.campo-metodo').value.trim(),
      observacion: tr.querySelector('.campo-obs').value.trim(),
      accion: "enviar_validacion" // ‚úÖ clave correcta para views.py
    };

    saves.push(fetch("{% url 'guardar_resultados_ajax' %}", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
      body: JSON.stringify(payload)
    }).then(r => r.json()).then(d => { if (d.status === 'ok' || d.status === 'redirect') ok++; else fail++; }).catch(() => { fail++; }));
  });

  await Promise.all(saves);
  closeModal(modalResumen);

  if (ok > 0 && enviarValidacion) {
    showAlert('Resultados enviados a validaci√≥n');
    setTimeout(() => {
      window.location.href = "{% url 'resultados_lista' %}";
    }, 1000);
  } else if (fail > 0) {
    showAlert('No se pudo guardar', true);
  }
});



});
</script>
{% endblock %}