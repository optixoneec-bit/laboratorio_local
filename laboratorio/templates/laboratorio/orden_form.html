{% extends "base_star.html" %}
{% load static %}
{% block title %}Nueva Orden ‚Äî VitalityAI{% endblock %}

{% block extra_head %}
<style>
/* üö® NOTA: Se mantienen solo los estilos que NO se pueden lograr f√°cilmente con clases de Bootstrap/Star Admin. */

/* --- Estilos base de los inputs y etiquetas (Asegurar que se ven bien) --- */
.form-control, .slx-input {
    border-radius: 4px; /* Estilo de Star Admin */
    padding: 0.8rem 1rem;
    height: auto;
}

/* --- T√≠tulo de Secci√≥n (Usamos un fondo de color primario de Star Admin) --- */
.slx-title{
  background: var(--bs-primary); /* Usa la variable primaria de Bootstrap/Star Admin */
  color: #fff;
  font-weight: 600;
  padding: 10px 15px;
  border-radius: 6px;
  margin-bottom: 15px;
  text-transform: uppercase;
  font-size: 0.95rem;
}

/* --- Bot√≥n Nuevo Paciente --- */
.slx-btn-row{text-align:center;margin-bottom:15px;}
.slx-new-patient{
  background: var(--bs-success); 
  color: #fff;
  font-weight: 600;
  padding: 8px 16px;
  border-radius: 6px;
  border: 0;
  cursor: pointer;
  font-size: 0.9rem;
  transition: background 0.2s;
}
.slx-new-patient:hover{ background: var(--bs-green-800); }

/* --- Componentes de B√∫squeda --- */
.slx-searchrow{display:flex;gap:8px;}
.slx-iconbtn{
  border: 1px solid var(--bs-gray-300);
  border-radius: 4px;
  background: var(--bs-gray-100);
  padding: 0 12px;
  cursor: pointer;
  font-size: 1rem;
  display: flex;
  align-items: center;
  transition: all 0.2s;
}
.slx-iconbtn:hover{background: var(--bs-gray-200);}
.slx-searchbar{display:flex;align-items:center;gap:8px;margin-bottom:15px;position:relative;}

/* Botones de acciones peque√±as */
.slx-mini-btn{
  border:1px solid var(--bs-primary);
  background: var(--bs-primary-bg-subtle);
  color: var(--bs-primary);
  padding:8px 10px;
  border-radius:4px;
  font-weight:600;
  font-size:.8rem;
  cursor:pointer;
  white-space: nowrap;
  transition: all 0.2s;
}
.slx-mini-btn:hover{ background: var(--bs-primary); color: #fff; }

/* --- TABLA DE EX√ÅMENES --- */
.slx-tablewrap{
  border: 1px solid var(--bs-border-color);
  border-radius: 6px;
  overflow: hidden;
  background: #fff;
}
.slx-thead{
  display:grid;
  grid-template-columns:80px 1fr 100px 100px 100px 60px;
  background: var(--bs-info); 
  color: #fff;
  font-weight: 600;
  font-size: 0.8rem;
}
.slx-thead>div{ padding: 10px 12px; border-right: 1px solid rgba(255,255,255,.2); }
.slx-row{
  display:grid;
  grid-template-columns:80px 1fr 100px 100px 100px 60px;
  align-items:center;
  padding: 10px 12px;
  border-top: 1px solid var(--bs-border-color);
  font-size: 0.9rem;
}
.slx-row:hover{ background: var(--bs-gray-100); }

/* Bot√≥n Eliminar */
.btn-del{
  background: var(--bs-danger);
  color: #fff;
  border: 0;
  border-radius: 4px;
  padding: 5px 8px;
  cursor: pointer;
  font-size: 0.8rem;
}
.btn-del:hover{ background: var(--bs-danger-dark); }

/* Fila de Total */
.slx-totalrow{
  display:grid;
  grid-template-columns:1fr 260px;
  border-top: 1px solid var(--bs-border-color);
  background: var(--bs-light);
}
.slx-total{
  display:flex;
  justify-content:flex-end;
  gap: 15px;
  align-items:center;
  padding: 12px;
  font-weight: 700;
  font-size: 1.1rem;
}

/* --- Botones CTA --- */
.slx-foot-title{
  background: var(--bs-primary);
  color: #fff;
  padding: 10px 15px;
  border-radius: 6px;
  font-weight: 600;
  margin: 20px 0 12px;
  font-size: 0.95rem;
}
.slx-cta{ display:grid; grid-template-columns:1fr 1fr 1fr; gap: 15px; }
.slx-big{
  display:flex; align-items:center; justify-content:center; gap: 8px;
  border-radius: 4px; padding: 15px 0; font-size: 0.9rem; font-weight: 600;
  border: 0; cursor:pointer; transition: all 0.2s;
}
.slx-big--blue{ background: var(--bs-info); color: #fff; }
.slx-big--green{ background: var(--bs-success); color: #fff; }
.slx-big--red{ background: var(--bs-danger); color: #fff; }
.slx-big:hover{ opacity: .9; box-shadow: 0 4px 8px rgba(0,0,0,.1); }
.slx-obs textarea{ margin-top:10px; border-radius: 4px; }

/* Resultados de b√∫squeda */
.resultados-busqueda{
  position:absolute; top:100%; left:0; right:0; background: #fff;
  border: 1px solid var(--bs-border-color); border-radius: 6px;
  max-height: 300px; overflow: auto; z-index: 2000;
  box-shadow: 0 4px 12px rgba(0,0,0,.1);
}
.resultado-item{
  display:grid; grid-template-columns:100px 1fr 100px;
  padding: 10px 12px; font-size: 0.9rem; cursor:pointer; align-items:center;
}
.resultado-item:hover{ background: var(--bs-gray-100); }
.resultado-item strong{ color: var(--bs-primary); }

/* Etiquetas y Muestras */
.slx-sample-btn {
  background-color: var(--bs-light) !important;
  border-color: var(--bs-gray-300) !important;
  color: var(--bs-gray-700) !important;
  font-weight: 500;
  border-radius: 4px !important;
  padding: 6px 10px !important;
  font-size: 0.85rem !important;
}

/* --- MODAL --- */
.slx-modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:5000;}
.slx-modal.show{display:flex;}
.slx-modal__card{background:#fff;border-radius:8px;min-width:320px;max-width:520px;width:92%;box-shadow:0 15px 40px rgba(0,0,0,.3);overflow:hidden;}
.slx-modal__head{
  background: var(--bs-primary); color:#fff; font-weight:600; padding:15px 20px;
  display:flex;justify-content:space-between;align-items:center; font-size:1.1rem;
}
.slx-modal__head .slx-btn--sec { background:transparent;color:white;font-size:1.2rem;padding:6px 10px;opacity:.9; }
.slx-modal__body{padding:20px;}
.slx-modal__foot{display:flex;gap:10px;justify-content:flex-end;padding:15px 20px;border-top:1px solid var(--bs-border-color);}
.slx-btn{border:0;border-radius:4px;padding:8px 12px;font-weight:600;cursor:pointer;}
.slx-btn--sec{background: var(--bs-light); color: var(--bs-gray-700);}
.slx-btn--pri{background: var(--bs-success);color:#fff;}

@media (max-width: 768px){
  .slx-thead, .slx-row{
    grid-template-columns: 80px 1fr 80px 80px 80px 50px;
    font-size: 0.75rem;
  }
  .slx-totalrow{ grid-template-columns: 1fr 180px; }
  .slx-cta{ grid-template-columns: 1fr; }
}
</style>
{% endblock %}

{% block content %}

<div class="page-header">
  <h3 class="page-title"> Nueva Orden </h3>
</div>

<form id="formNuevaOrden" method="post" class="slx-form">
  {% csrf_token %}

  <div class="row">
    <div class="col-lg-4 grid-margin stretch-card"> 
      <div class="card">
        <div class="card-body">
          <div class="slx-panel">
            <div class="slx-body">
              <header class="slx-title">Datos del paciente</header>

              <div class="slx-btn-row">
                <button type="button" id="btnNuevoPaciente" class="slx-new-patient">
                  <i class="mdi mdi-account-plus-outline"></i> Nuevo Paciente
                </button>
              </div>

              <div class="slx-block">
                <label class="slx-label">C√©dula:<span class="text-danger">*</span></label>
                <div class="slx-searchrow">
                  <input type="text" id="campoDoc" name="documento_identidad" class="form-control" placeholder="C√©dula" required>
                  <button type="button" id="btnBuscarPaciente" class="slx-iconbtn" data-url="{% url 'buscar_paciente_ajax' %}">üîç</button>
                </div>
              </div>

              <div class="slx-block">
                <label class="slx-label">Nombre completo:<span class="text-danger">*</span></label>
                <input type="text" id="campoNombre" name="nombre_completo" class="form-control" placeholder="Nombre del paciente" required>
                <p id="avisoPaciente" class="small"></p>
              </div>

              <div class="slx-block">
                <div class="slx-priority">
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="tipo" id="radioUrgente" value="Urgente">
                    <label class="form-check-label" for="radioUrgente">Urgente</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="tipo" id="radioPrioridad" value="Prioridad">
                    <label class="form-check-label" for="radioPrioridad">Prioridad</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="tipo" id="radioRutina" value="Rutina" checked>
                    <label class="form-check-label" for="radioRutina">Rutina</label>
                  </div>
                </div>
              </div>

              <div class="slx-block">
                <label class="slx-label">M√©dico solicitante</label>
                <input type="text" name="medico" class="form-control" placeholder="Nombre del m√©dico">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-8 grid-margin stretch-card"> 
      <div class="card">
        <div class="card-body">
          <div class="slx-panel">
            <div class="slx-body">
              <header class="slx-title">Informaci√≥n de la orden</header>

              <div class="slx-searchbar">
                <input type="text" class="form-control slx-input--search" placeholder="Buscar An√°lisis">
                <div class="slx-mini-actions">
                  <button type="button" class="slx-mini-btn">PERFILES</button>
                  <button type="button" class="slx-mini-btn">POR. GENERAL</button>
                </div>
                <div class="resultados-busqueda" id="resultadosBusqueda" style="display:none;"></div>
              </div>

              <div class="slx-tablewrap">
                <div class="slx-thead">
                  <div>C√ìDIGO</div><div>AN√ÅLISIS</div><div>ESTADO</div><div style="text-align:right;">V. PACIENTE</div><div style="text-align:right;">V. POSPAGO</div><div></div>
                </div>
                <div class="slx-tbody" id="tbodyExamenes">
                  <div class="slx-empty">No existen ex√°menes agregados</div>
                </div>
                <div class="slx-totalrow">
                  <div class="slx-total"><span>Total:</span><strong id="totalValor">$0.00</strong></div>
                </div>
              </div>

              <div class="slx-samples" style="margin-top:20px; display:flex; flex-wrap:wrap; gap:10px;">
                <!-- üëâ Bot√≥n Etiquetas como SUBMIT con name=accion -->
                <button type="submit" id="btnEtiquetas" name="accion" value="etiquetas"
                        class="slx-sample-btn btn btn-sm btn-light">üßæ Etiquetas</button>
              </div>

              <div class="slx-foot">
                <div class="slx-foot-title">Generalidades</div>
                <div class="slx-cta">
                  <button type="button" id="slxObs" class="slx-big slx-big--blue">
                    <i class="mdi mdi-eye"></i> Observaciones
                  </button>
                  <button type="submit" class="slx-big slx-big--green">
                    <i class="mdi mdi-content-save"></i> Guardar
                  </button>
                  <button type="reset" class="slx-big slx-big--red">
                    <i class="mdi mdi-delete-sweep"></i> Limpiar
                  </button>
                </div>
                <div id="slxObsArea" class="slx-obs" hidden>
                  <textarea class="form-control" name="observaciones" rows="3" placeholder="Escribe observaciones‚Ä¶"></textarea>
                </div>
              </div>

            </div> </div> </div> </div> </div>
  </div> </form>

<div id="modalPaciente" class="slx-modal" aria-hidden="true" role="dialog">
  <div class="slx-modal__card">
    <div class="slx-modal__head">
      <span>Nuevo Paciente</span>
      <button type="button" id="mpCerrar" class="slx-btn slx-btn--sec">‚úñ</button>
    </div>
    <div class="slx-modal__body">
      <div class="slx-block">
        <label class="slx-label">C√©dula <span class="text-danger">*</span></label>
        <input type="text" id="mpDoc" class="form-control" placeholder="C√©dula">
      </div>
      <div class="slx-block">
        <label class="slx-label">Nombres <span class="text-danger">*</span></label>
        <input type="text" id="mpNombres" class="form-control" placeholder="Nombres">
      </div>
      <div class="slx-block">
        <label class="slx-label">Apellidos</label>
        <input type="text" id="mpApellidos" class="form-control" placeholder="Apellidos">
      </div>
      <div class="slx-block">
        <label class="slx-label">Sexo</label>
        <select id="mpSexo" class="form-select">
          <option value="">‚Äî</option>
          <option value="M">Masculino</option>
          <option value="F">Femenino</option>
        </select>
      </div>
      <div class="slx-block">
        <label class="slx-label">Fecha de nacimiento</label>
        <input type="date" id="mpFNac" class="form-control">
      </div>
      <div class="slx-block">
        <label class="slx-label">Tel√©fono</label>
        <input type="text" id="mpTel" class="form-control" placeholder="Tel√©fono">
      </div>
      <div class="slx-block">
        <label class="slx-label">Email</label>
        <input type="email" id="mpMail" class="form-control" placeholder="correo@dominio.com">
      </div>
      <div class="slx-block">
        <label class="slx-label">Direcci√≥n</label>
        <input type="text" id="mpDir" class="form-control" placeholder="Direcci√≥n">
      </div>
      <small id="mpAviso" class="d-block mt-2 text-muted"></small>
    </div>
    <div class="slx-modal__foot">
      <button type="button" id="mpCancelar" class="slx-btn slx-btn--sec">Cancelar</button>
      <button type="button" id="mpGuardar" class="slx-btn slx-btn--pri">Guardar</button>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
(function(){
  // Observaciones
  const btnObs=document.getElementById('slxObs');
  const areaObs=document.getElementById('slxObsArea');
  if(btnObs&&areaObs){btnObs.addEventListener('click',()=>areaObs.toggleAttribute('hidden'));}

  const inputBuscar=document.querySelector('.slx-input--search');
  const lista=document.getElementById('resultadosBusqueda');
  const tbody=document.getElementById('tbodyExamenes');
  const totalElem=document.getElementById('totalValor');
  let total=0, delayTimer;

  // Avisos
  const aviso = document.getElementById('avisoPaciente');
  function setAviso(msg, cls){
    if(!aviso) return;
    aviso.className = 'small';
    aviso.style.display='block';
    if(cls === 'ok') aviso.classList.add('text-success');
    else if (cls === 'err') aviso.classList.add('text-danger');
    else aviso.classList.add('text-muted');
    aviso.textContent = msg;
  }

  // Buscar paciente
  const btnBuscarPaciente = document.getElementById('btnBuscarPaciente');
  const campoDoc = document.getElementById('campoDoc');
  const campoNombre = document.getElementById('campoNombre');

  btnBuscarPaciente.addEventListener('click', function(){
    const url = btnBuscarPaciente.dataset.url;
    const doc = (campoDoc.value || '').trim();
    if(!doc){ setAviso('Ingresa la c√©dula para buscar.', 'err'); return; }

    $.get(url, { documento_identidad: doc }, function(resp){
      if(resp.status === 'ok' && resp.paciente){
        campoNombre.value = resp.paciente.nombre_completo || '';
        setAviso('Paciente encontrado.', 'ok');
      } else if (resp.status === 'not_found') {
        setAviso('Paciente no registrado. Usa ‚Äú+ Nuevo Paciente‚Äù.', 'err');
      } else if (resp.status === 'error') {
        setAviso(resp.message || 'Error al buscar.', 'err');
      } else {
        setAviso('Sin respuesta v√°lida.', 'err');
      }
    }).fail(function(xhr){
      setAviso('No se pudo conectar (' + xhr.status + ').', 'err');
    });
  });

  campoDoc.addEventListener('keydown', function(e){
    if(e.key === 'Enter'){ e.preventDefault(); btnBuscarPaciente.click(); }
  });

  // ---------- MODAL NUEVO PACIENTE ----------
  const modal = document.getElementById('modalPaciente');
  const btnNuevo = document.getElementById('btnNuevoPaciente');
  const mpCerrar = document.getElementById('mpCerrar');
  const mpCancelar = document.getElementById('mpCancelar');
  const mpGuardar = document.getElementById('mpGuardar');
  const mpAviso = document.getElementById('mpAviso');
  const mpDoc = document.getElementById('mpDoc');
  const mpNom = document.getElementById('mpNombres');
  const mpApe = document.getElementById('mpApellidos');
  const mpSexo = document.getElementById('mpSexo');
  const mpFNac = document.getElementById('mpFNac');
  const mpTel = document.getElementById('mpTel');
  const mpMail = document.getElementById('mpMail');
  const mpDir = document.getElementById('mpDir');

  function openModal(){
    mpDoc.value = (campoDoc.value || '').trim();
    const partes = (campoNombre.value || '').trim().split(' ');
    mpNom.value = partes.length ? partes[0] : '';
    mpApe.value = partes.slice(1).join(' ');
    mpSexo.value = '';
    mpFNac.value = '';
    mpTel.value=''; mpMail.value=''; mpDir.value='';
    mpAviso.textContent='';
    modal.classList.add('show'); modal.setAttribute('aria-hidden','false');
  }
  function closeModal(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }

  btnNuevo.addEventListener('click', openModal);
  mpCerrar.addEventListener('click', closeModal);
  mpCancelar.addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });

  mpGuardar.addEventListener('click', async ()=>{
    const doc = mpDoc.value.trim();
    const nombres = mpNom.value.trim();
    const apellidos = mpApe.value.trim();
    if(!doc || !nombres){ mpAviso.classList.add('text-danger'); mpAviso.textContent='C√©dula y Nombres son obligatorios.'; return; }

    const url = "{% url 'paciente_nuevo_ajax' %}";
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const fechaNacimiento = mpFNac.value.trim() === '' ? '' : mpFNac.value;

    const body = new URLSearchParams({
      documento_identidad: doc,
      nombres: nombres,
      apellidos: apellidos,
      sexo: mpSexo.value,
      fecha_nacimiento: fechaNacimiento,
      telefono: mpTel.value,
      email: mpMail.value,
      direccion: mpDir.value
    });

    try{
      const r = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type':'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken,
          'X-Requested-With':'XMLHttpRequest'
        },
        body: body.toString()
      });
      const data = await r.json();
      if(r.ok && data.status === 'ok'){
        campoDoc.value = data.paciente.documento_identidad || doc;
        campoNombre.value = data.paciente.nombre_completo || (nombres + (apellidos?(' '+apellidos):''));
        setAviso('Paciente creado.', 'ok');
        closeModal();
      }else{
        mpAviso.classList.add('text-danger');
        mpAviso.textContent = (data && data.message) ? data.message : 'No se pudo crear el paciente.';
      }
    }catch(e){
      mpAviso.classList.add('text-danger');
      mpAviso.textContent='Error de red al crear paciente.';
    }
  });

  // ---------- B√öSQUEDA DE EX√ÅMENES ----------
  if (inputBuscar){
    inputBuscar.addEventListener('keyup', function(){
      clearTimeout(delayTimer);
      const q=this.value.trim();
      delayTimer=setTimeout(()=>{
        if(q.length<2){lista.style.display='none';return;}
        $.get("{% url 'buscar_examenes_ajax' %}",{q:q},function(resp){
          if(resp.status==="ok" && resp.resultados.length){
            lista.innerHTML=resp.resultados.map(e=>`
              <div class="resultado-item" data-codigo="${e.codigo}" data-nombre="${e.nombre}" data-precio="${e.precio}">
                <strong>${e.codigo}</strong><span>${e.nombre}</span><div style="text-align:right;">$${Number(e.precio).toFixed(2)}</div>
              </div>`).join('');
            lista.style.display='block';
          }else{
            lista.innerHTML='<div class="resultado-item text-muted">No se encontraron resultados.</div>';
            lista.style.display='block';
          }
        });
      },250);
    });
  }

  lista.addEventListener('click',function(e){
    const item=e.target.closest('.resultado-item');
    if(!item)return;
    const codigo=item.dataset.codigo,nombre=item.dataset.nombre,precio=parseFloat(item.dataset.precio||'0');
    const row=document.createElement('div');
    row.className='slx-row';
    row.innerHTML=`
      <div>${codigo}</div>
      <div>${nombre}</div>
      <div><span class="badge bg-info text-white">Pendiente</span></div>
      <div style="text-align:right;">$${precio.toFixed(2)}</div>
      <div style="text-align:right;">$${precio.toFixed(2)}</div>
      <div><button type="button" class="btn-del">‚úñ</button></div>`;
    const empty=tbody.querySelector('.slx-empty');
    if(empty)empty.remove();
    tbody.appendChild(row);
    total+=precio;
    totalElem.textContent=`$${total.toFixed(2)}`;
    lista.style.display='none';
    inputBuscar.value='';
  });

  tbody.addEventListener('click',function(e){
    if(e.target.classList.contains('btn-del')){
      const row=e.target.closest('.slx-row');
      const val=row.querySelectorAll('div')[3];
      if(val){total-=parseFloat((val.textContent||'').replace('$',''))||0;}
      totalElem.textContent=`$${total.toFixed(2)}`;
      row.remove();
      if(!tbody.querySelector('.slx-row'))
        tbody.innerHTML='<div class="slx-empty">No existen ex√°menes agregados</div>';
    }
  });

  const form=document.getElementById('formNuevaOrden');

  form.addEventListener('reset',()=>{
    tbody.innerHTML='<div class="slx-empty">No existen ex√°menes agregados</div>';
    total=0;
    totalElem.textContent='$0.00';
    if(areaObs) areaObs.hidden=true;
    if(aviso){aviso.style.display='none';}
  });

  // ---------- Env√≠o: genera insumos ocultos con ex√°menes ----------
  form.addEventListener('submit', function() {
    // Limpia inputs previos
    form.querySelectorAll('input[name="examen_codigo[]"], input[name="examen_precio[]"]').forEach(el => el.remove());
    // Arma para cada fila
    const filas = tbody.querySelectorAll('.slx-row');
    filas.forEach(f => {
      const celdas = f.querySelectorAll('div');
      if (celdas.length >= 5) {
        const codigo = celdas[0].textContent.trim();
        const precio = (celdas[3].textContent || '').replace('$','').trim();
        const inputCodigo = document.createElement('input'); inputCodigo.type='hidden'; inputCodigo.name='examen_codigo[]'; inputCodigo.value=codigo;
        const inputPrecio = document.createElement('input'); inputPrecio.type='hidden'; inputPrecio.name='examen_precio[]'; inputPrecio.value=precio;
        form.appendChild(inputCodigo); form.appendChild(inputPrecio);
      }
    });
  });
})();
</script>
{% endblock %}
