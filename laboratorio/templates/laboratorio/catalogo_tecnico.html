{% extends "base_star.html" %}
{% load static %}
{% block title %}Cat√°logo T√©cnico{% endblock %}

{% block extra_head %}
<style>
/* === TARJETA STARADMIN === */
.slx-card{
    background:#fff;
    border-radius:12px;
    box-shadow:0 2px 6px rgba(0,0,0,.05);
    padding:24px;
}

/* === HEADER === */
.slx-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-wrap:wrap;
    gap:14px;
    margin-bottom:18px;
}

/* === BUSCADOR === */
.slx-search{
    width:360px;
}
.slx-search input{
    width:100%;
    border:1px solid #d9d9d9;
    border-radius:8px;
    padding:8px 12px;
    font-size:.95rem;
}

/* === BOTONES === */
.btn-purple{
    background:#2b18ff!important;
    color:#fff!important;
    border-radius:10px!important;
    font-weight:600!important;
}
.btn-gray{
    background:#eef2f6!important;
    color:#333!important;
    border-radius:10px!important;
}
.btn-red{
    background:#ffe3e3!important;
    color:#c62828!important;
    border-radius:10px!important;
}

/* === TABLA === */
.table thead th{
    background:#f3f4f6!important;
    border-bottom:1px solid #e0e0e0!important;
    font-weight:600!important;
}
.table-hover tbody tr:hover{
    background:#f5f7fb!important;
}
.table td{
    vertical-align:middle!important;
    padding:14px 10px!important;
    font-size:.90rem;
}

/* === BOTONES DE ACCI√ìN === */
.action{
    padding:6px 10px;
    border-radius:8px;
    font-size:.85rem;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
}
.action-edit{
    background:#eceaff;
    color:#2b18ff;
}
.action-del{
    background:#ffecec;
    color:#d83a3a;
}
</style>
{% endblock %}

{% block content %}
<div class="slx-card">

    <div class="slx-header">
        <h4 style="margin:0;font-weight:700;color:#2a2f36;">Cat√°logo T√©cnico</h4>

        <div class="d-flex align-items-center" style="gap:10px;">
            <div class="slx-search">
                <input type="search" id="buscarParametro" value="{{ query }}" placeholder="Buscar por examen o par√°metro‚Ä¶">
            </div>

            <button id="btn-nuevo" class="btn btn-purple btn-sm">‚ûï Nuevo</button>
            <button id="btn-importar" class="btn btn-gray btn-sm">‚¨ÜÔ∏è Importar</button>
            <a href="{% url 'catalogo_tecnico_export' %}" class="btn btn-gray btn-sm">‚¨áÔ∏è Exportar</a>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>C√≥digo</th>
                    <th>Examen</th>
                    <th>Par√°metro</th>
                    <th>Unidad</th>
                    <th>Referencia</th>
                    <th>M√©todo</th>
                    <th>Obs.</th>
                    <th class="text-center">Acciones</th>
                </tr>
            </thead>
            <tbody>
            {% for p in page_obj %}
                <tr data-id="{{ p.id }}" data-acreditado="{{ p.acreditado|yesno:'true,false' }}">
                    <td>{{ p.examen.codigo }}</td>
                    <td>{{ p.examen.nombre }}</td>
                    <td>{{ p.nombre }}</td>
                    <td>{{ p.unidad }}</td>
                    <td>{{ p.referencia }}</td>
                    <td>{{ p.metodo }}</td>
                    <td>{{ p.observacion }}</td>
                    <td class="text-center">
                        <button class="action action-edit btn-edit">‚úèÔ∏è</button>
                        <button class="action action-del btn-del">üóëÔ∏è</button>
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="8" class="text-center text-muted py-3">No hay par√°metros registrados</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- PAGINACI√ìN -->
    {% if page_obj.has_other_pages %}
    <div class="d-flex justify-content-end align-items-center mt-3 gap-2">

        {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query }}{% endif %}" class="btn btn-gray btn-sm">‚Üê</a>
        {% endif %}

        <span>P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>

        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query }}{% endif %}" class="btn btn-gray btn-sm">‚Üí</a>
        {% endif %}

    </div>
    {% endif %}

</div>


<!-- ========== MODAL NUEVO / EDITAR (CORREGIDO) ========== -->
<div class="modal fade" id="modalParametro" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Par√°metro</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="formParametro">
          {% csrf_token %}

          <input type="hidden" id="editId" name="id">

          <div class="row g-3">

            <div class="col-12">
              <label class="form-label">Examen</label>
              <input type="text" class="form-control" id="examenBuscar" name="examen_busqueda">
            </div>

            <div class="col-md-6">
              <label class="form-label">Par√°metro *</label>
              <input type="text" class="form-control" id="parametro" name="nombre">
            </div>

            <div class="col-md-6">
              <label class="form-label">Unidad</label>
              <input type="text" class="form-control" id="unidad" name="unidad">
            </div>

            <div class="col-md-6">
              <label class="form-label">Referencia</label>
              <input type="text" class="form-control" id="referencia" name="referencia">
            </div>

            <div class="col-md-6">
              <label class="form-label">M√©todo</label>
              <input type="text" class="form-control" id="metodo" name="metodo">
            </div>

            <div class="col-12">
              <label class="form-label">Observaci√≥n</label>
              <input type="text" class="form-control" id="observacion" name="observacion">
            </div>

            <div class="col-12">
              <label class="form-label d-flex align-items-center gap-2">
                <input type="checkbox" id="acreditado" name="acreditado">
                Acreditado
              </label>
            </div>

          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-gray" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-purple" id="guardarParametro">Guardar</button>
      </div>

    </div>
  </div>
</div>


<!-- ========== MODAL IMPORTAR ========== -->
<div class="modal fade" id="modalImportar" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Importar par√°metros</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="formImportar" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="file" name="archivo" class="form-control" accept=".xlsx,.xls,.csv" required>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-gray" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-purple" id="importarArchivo">Importar</button>
      </div>

    </div>
  </div>
</div>

{% endblock %}


{% block extra_js %}
<script>
$(function(){

    const modalParametro = new bootstrap.Modal(document.getElementById('modalParametro'));
    const modalImportar  = new bootstrap.Modal(document.getElementById('modalImportar'));

    /* ---------------- BUSCADOR ---------------- */
    let timer;
    $('#buscarParametro').on('keyup', function(){
        clearTimeout(timer);
        const q = $(this).val();
        timer = setTimeout(() => {
            const url = new URL(window.location.href);
            if(q) url.searchParams.set('q', q);
            else url.searchParams.delete('q');
            url.searchParams.delete('page');
            window.location.href = url.toString();
        },400);
    });

    /* ---------------- NUEVO ---------------- */
    $('#btn-nuevo').on('click', function(){
        $('#formParametro')[0].reset();
        $('#editId').val('');
        modalParametro.show();
    });

    /* ---------------- EDITAR ---------------- */
    $('.btn-edit').on('click', function(){
        const tr = $(this).closest('tr');

        $('#editId').val(tr.data('id'));
        $('#examenBuscar').val(tr.find('td:eq(1)').text().trim());
        $('#parametro').val(tr.find('td:eq(2)').text().trim());
        $('#unidad').val(tr.find('td:eq(3)').text().trim());
        $('#referencia').val(tr.find('td:eq(4)').text().trim());
        $('#metodo').val(tr.find('td:eq(5)').text().trim());
        $('#observacion').val(tr.find('td:eq(6)').text().trim());
        $('#acreditado').prop('checked', tr.data('acreditado') === 'true');

        modalParametro.show();
    });

    /* ---------------- GUARDAR ---------------- */
    $('#guardarParametro').on('click', function(){

        const datos = new FormData(document.getElementById('formParametro'));
        const id = $('#editId').val();

        if(id) datos.append('id', id);

        $.ajax({
            method:'POST',
            url: id ? "{% url 'catalogo_tecnico_save' %}" : "{% url 'catalogo_tecnico_create' %}",
            data:datos,
            processData:false,
            contentType:false,
            headers:{
                "X-CSRFToken": $('input[name="csrfmiddlewaretoken"]').val()
            },
            success:function(resp){
                if(resp.status==='ok'){
                    modalParametro.hide();
                    location.reload();
                } else {
                    alert(resp.message || "Error al guardar");
                }
            }
        });
    });

    /* ---------------- ELIMINAR ---------------- */
    $('.btn-del').on('click', function(){
        if(!confirm("¬øEliminar este par√°metro?")) return;

        const tr = $(this).closest('tr');
        const id = tr.data('id');

        $.post("{% url 'catalogo_tecnico_delete' %}", {
            csrfmiddlewaretoken:'{{ csrf_token }}',
            id:id
        }, function(resp){
            if(resp.status==='ok'){
                tr.remove();
            }
        });
    });

    /* ---------------- IMPORTAR ---------------- */
    $('#btn-importar').on('click', ()=> modalImportar.show());

    $('#importarArchivo').on('click', function(){
        const datos = new FormData(document.getElementById('formImportar'));

        $.ajax({
            method:'POST',
            url:"{% url 'catalogo_tecnico_import' %}",
            data:datos,
            processData:false,
            contentType:false,
            success:function(resp){
                if(resp.status==='ok'){
                    modalImportar.hide();
                    location.reload();
                }
            }
        });
    });

});
</script>
{% endblock %}
