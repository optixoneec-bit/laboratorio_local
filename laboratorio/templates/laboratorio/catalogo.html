{% extends "base_star.html" %}
{% load static %}
{% block title %}Cat√°logo de Ex√°menes{% endblock %}

{% block extra_head %}
<style>
/* === TARJETA STARADMIN === */
.slx-card{
    background:#fff;
    border-radius:12px;
    box-shadow:0 2px 6px rgba(0,0,0,.05);
    padding:24px;
}

/* === HEADER === */
.slx-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-wrap:wrap;
    gap:14px;
    margin-bottom:18px;
}

/* === BUSCADOR === */
.slx-search{
    width:320px;
}
.slx-search input{
    width:100%;
    border:1px solid #d9d9d9;
    border-radius:8px;
    padding:8px 12px;
}

/* === BOTONES === */
.btn-purple{
    background:#2b18ff!important;
    color:#fff!important;
    border-radius:10px!important;
    font-weight:600!important;
}
.btn-gray{
    background:#eef2f6!important;
    color:#333!important;
    border-radius:10px!important;
}
.btn-red{
    background:#ffe3e3!important;
    color:#c62828!important;
    border-radius:10px!important;
}

/* === TABLA === */
.table thead th{
    background:#f3f4f6!important;
    border-bottom:1px solid #e0e0e0!important;
    font-weight:600;
}
.table-hover tbody tr:hover{
    background:#f5f7fb!important;
}
.table td{
    vertical-align:middle!important;
    padding:14px 10px!important;
}

/* === BOTONES DE ACCI√ìN === */
.action{
    padding:6px 10px;
    border-radius:8px;
    font-size:.85rem;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
}
.action-edit{
    background:#eceaff;
    color:#2b18ff;
}
.action-del{
    background:#ffecec;
    color:#d83a3a;
}
</style>
{% endblock %}


{% block content %}

<div class="slx-card">

    <div class="slx-header">
        <h4 style="margin:0;font-weight:700;color:#2a2f36;">Cat√°logo de Ex√°menes</h4>

        <div class="d-flex align-items-center" style="gap:10px;">
            <div class="slx-search">
                <input type="search" id="buscarExamen" value="{{ query }}" placeholder="Buscar‚Ä¶">
            </div>

            <form method="post" action="{% url 'catalogo_importar_excel' %}" enctype="multipart/form-data" class="d-flex align-items-center gap-2">
                {% csrf_token %}
                <input type="file" name="archivo" accept=".xlsx" required>
                <button class="btn btn-purple btn-sm">üì§ Importar</button>
            </form>

            <a href="{% url 'catalogo_exportar' %}" class="btn btn-gray btn-sm">‚¨áÔ∏è Exportar</a>

            <button id="btnEliminarTodos" class="btn btn-red btn-sm">üßπ Eliminar Todos</button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>C√≥digo</th>
                    <th>Nombre</th>
                    <th>√Årea</th>
                    <th>Muestra</th>
                    <th class="text-end">Precio</th>
                    <th class="text-center">Acciones</th>
                </tr>
            </thead>

            <tbody>
            {% for e in examenes %}
                <tr data-id="{{ e.id }}">
                    <td>{{ e.codigo }}</td>
                    <td>{{ e.nombre }}</td>
                    <td>{{ e.area }}</td>
                    <td>{{ e.muestra|default:"‚Äî" }}</td>
                    <td class="text-end">${{ e.precio|floatformat:2 }}</td>
                    <td class="text-center">
                        <button class="action action-edit btn-edit">‚úèÔ∏è</button>
                        <button class="action action-del btn-del">üóëÔ∏è</button>
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="6" class="text-center text-muted py-3">Sin ex√°menes</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    {% if examenes.has_other_pages %}
    <div class="d-flex justify-content-end align-items-center mt-3 gap-2">
        {% if examenes.has_previous %}
        <a href="?page={{ examenes.previous_page_number }}{% if query %}&q={{ query }}{% endif %}" class="btn btn-gray btn-sm">‚Üê</a>
        {% endif %}

        <span>P√°gina {{ examenes.number }} de {{ examenes.paginator.num_pages }}</span>

        {% if examenes.has_next %}
        <a href="?page={{ examenes.next_page_number }}{% if query %}&q={{ query }}{% endif %}" class="btn btn-gray btn-sm">‚Üí</a>
        {% endif %}
    </div>
    {% endif %}
</div>


<!-- ===================== MODAL EDITAR ===================== -->
<div class="modal fade" id="modalEditar" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Editar examen</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="editId">

        <label class="form-label">C√≥digo</label>
        <input class="form-control" id="editCodigo">

        <label class="form-label mt-2">Nombre</label>
        <input class="form-control" id="editNombre">

        <label class="form-label mt-2">√Årea</label>
        <input class="form-control" id="editArea">

        <label class="form-label mt-2">Tipo muestra</label>
        <input class="form-control" id="editMuestra">

        <label class="form-label mt-2">Precio</label>
        <input type="number" step="0.01" class="form-control" id="editPrecio">
      </div>

      <div class="modal-footer">
        <button class="btn btn-gray" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-purple" id="guardarCambios">Guardar</button>
      </div>

    </div>
  </div>
</div>


<!-- ===================== MODAL ELIMINAR ===================== -->
<div class="modal fade" id="modalEliminar" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Eliminar examen</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        ¬øSeguro que deseas eliminar este examen?
      </div>

      <div class="modal-footer">
        <button class="btn btn-gray" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-red" id="confirmarEliminar">Eliminar</button>
      </div>

    </div>
  </div>
</div>




{% endblock %}



{% block extra_js %}
<script>
$(function(){

    /* ---------------- BUSCADOR ---------------- */
    let timer;
    $('#buscarExamen').on('keyup', function(){
        clearTimeout(timer);
        const q = $(this).val();
        timer = setTimeout(() => {
            const url = new URL(window.location.href);
            if(q) url.searchParams.set('q', q);
            else url.searchParams.delete('q');
            url.searchParams.delete('page');
            window.location.href = url.toString();
        },400);
    });

    /* ---------------- MODALES ---------------- */
    const modalEditar  = new bootstrap.Modal(document.getElementById('modalEditar'));
    const modalEliminar = new bootstrap.Modal(document.getElementById('modalEliminar'));
    let examenAEliminar = null;

    /* ---------------- EDITAR ---------------- */
    $('.btn-edit').on('click', function(){
        const row = $(this).closest('tr');

        $('#editId').val(row.data('id'));
        $('#editCodigo').val(row.find('td:eq(0)').text().trim());
        $('#editNombre').val(row.find('td:eq(1)').text().trim());
        $('#editArea').val(row.find('td:eq(2)').text().trim());
        $('#editMuestra').val(row.find('td:eq(3)').text().trim());
        $('#editPrecio').val(row.find('td:eq(4)').text().replace('$','').trim());

        modalEditar.show();
    });

    $('#guardarCambios').on('click', function(){
        const id = $('#editId').val();

        $.post(`/catalogo/${id}/editar/`, {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            codigo: $('#editCodigo').val(),
            nombre: $('#editNombre').val(),
            area: $('#editArea').val(),
            muestra: $('#editMuestra').val(),
            precio: $('#editPrecio').val()
        }, function(resp){
            if(resp.status === 'ok') location.reload();
        });
    });

    /* ---------------- ELIMINAR ---------------- */
    $('.btn-del').on('click', function(){
        examenAEliminar = $(this).closest('tr').data('id');
        modalEliminar.show();
    });

    $('#confirmarEliminar').on('click', function(){
        if(!examenAEliminar) return;

        $.post(`/catalogo/${examenAEliminar}/eliminar/`, {
            csrfmiddlewaretoken:'{{ csrf_token }}'
        }, function(resp){
            if(resp.status === 'ok') location.reload();
        });
    });

    /* ---------------- ELIMINAR TODOS ---------------- */
    $('#btnEliminarTodos').on('click', function(){
        if(!confirm("Esto eliminar√° TODOS los ex√°menes.")) return;

        $.post("{% url 'catalogo_eliminar_todos_ajax' %}", {
            csrfmiddlewaretoken:'{{ csrf_token }}'
        }, function(resp){
            if(resp.status === 'ok'){
                alert('Todos eliminados.');
                location.reload();
            }
        });
    });

});
</script>
{% endblock %}
